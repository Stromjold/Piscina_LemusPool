<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Administraci√≥n - LemusPool</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/admin_principal.css">

    <style>
        /* Extra√≠do de admin_principal.html - estilos del panel de administraci√≥n */
/* --- 1. Variables Globales y Estilo Base --- */
:root {
    --bg-dark-main: #1a2035;      /* Fondo principal muy oscuro */
    --bg-dark-secondary: #2a3450; /* Fondo de tarjetas y sidebar */
    --border-color: #3a4468;     /* Bordes sutiles */
    --primary-blue: #007bff;     /* Azul de tu sitio web */
    --primary-blue-hover: #0056b3;
    --text-primary: #ffffff;     /* Texto principal: blanco */
    --text-secondary: #ffffff;   /* Texto secundario: tambi√©n blanco */
    --green: #28a745;
    --red: #dc3545;
    --yellow: #ffc107;
    --gray: #6c757d;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-dark-main);
    color: var(--text-primary);
    display: flex;
}

h1, h2, h3, h4 {
    color: var(--text-primary);
    margin-bottom: 0.75rem;
}

p {
    color: var(--text-secondary);
    line-height: 1.6;
}

a {
    text-decoration: none;
    color: var(--primary-blue);
}

/* --- 2. Layout Principal (Sidebar + Contenido) --- */
.admin-panel {
    display: flex;
    width: 100%;
}

.sidebar {
    width: 240px;
    background-color: var(--bg-dark-secondary);
    height: 100vh;
    padding: 20px;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 900; /* Mantener por debajo del modal */
    border-right: 1px solid var(--border-color);
}

.sidebar h2 {
    text-align: center;
    color: #fff;
    margin-bottom: 30px;
    font-size: 1.5rem;
}

.sidebar nav ul {
    list-style: none;
}

.sidebar nav li a {
    display: block;
    padding: 12px 15px;
    color: var(--text-secondary);
    border-radius: 6px;
    margin-bottom: 5px;
    transition: background-color 0.2s, color 0.2s;
}

.sidebar nav li a:hover {
    background-color: var(--bg-dark-main);
    color: var(--text-primary);
}

.sidebar nav li a.active {
    background-color: var(--primary-blue);
    color: #fff;
    font-weight: 500;
}

.main-content {
    margin-left: 240px; /* Mismo ancho que el sidebar */
    flex-grow: 1;
    padding: 20px;
    height: 100vh;
    overflow-y: auto;
}

.main-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 20px;
}

.main-header input[type="search"] {
    background-color: var(--bg-dark-main);
    border: 1px solid var(--border-color);
    border-radius: 5px;
    padding: 8px 12px;
    color: var(--text-primary);
    width: 300px;
}

.main-header .profile {
    width: 40px;
    height: 40px;
    background-color: var(--primary-blue);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
}

/* --- 3. Contenedores de P√°gina --- */
.page {
    display: none; /* Ocultos por defecto, JS los mostrar√° */
}
.page.active {
    display: block;
}

/* --- 4. Estilos de Componentes --- */
.btn {
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}
.btn-primary {
    background-color: var(--primary-blue);
    color: #fff;
}
.btn-primary:hover {
    background-color: var(--primary-blue-hover);
}
.btn-secondary {
    background-color: var(--bg-dark-main);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}
.btn-secondary:hover {
    background-color: var(--border-color);
    color: var(--text-primary);
}

.status {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    color: #fff;
}
.status-active { background-color: var(--green); }
.status-late { background-color: var(--red); }
.status-pending { background-color: var(--yellow); color: #333; }
.status-canceled { background-color: var(--gray); }
.status-published { background-color: var(--green); }
.status-draft { background-color: var(--gray); }
        
/* Base de Tarjeta Gen√©rica */
.card {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
}

/* --- 5. Estilos por P√°gina --- */
        
/* == P√ÅGINA: DASHBOARD == */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.kpi-card {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
}
.kpi-card h3 {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 10px;
}
.kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
}
.kpi-change {
    font-size: 0.9rem;
    color: var(--green);
}
.kpi-change.negative {
    color: var(--red);
}

.chart-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
    align-items: start;
}
.chart-container {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 18px;
    min-height: 360px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: flex-start;
}
.chart-container h3 {
    margin: 0 0 12px 0;
    font-size: 1.05rem;
    color: var(--text-primary);
}
.chart-container .chart-placeholder { display: none; }
.chart-container canvas {
    width: 100% !important;
    height: calc(100% - 36px) !important;
    flex: 1 1 auto;
}

@media (max-width: 900px) {
    .chart-grid { grid-template-columns: 1fr; }
    .chart-container { min-height: 300px; }
}

/* == P√ÅGINA: SOLICITUDES == */
.inbox-layout {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 20px;
    height: calc(100vh - 160px); /* Alto de pantalla menos header y padding */
}
.inbox-list {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow-y: auto;
}
.inbox-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}
.inbox-item:hover {
    background-color: var(--bg-dark-main);
}
.inbox-item.active {
    background-color: var(--primary-blue);
}
.inbox-item h4 {
    font-size: 1rem;
    color: var(--text-primary);
}
.inbox-item h4.unread {
    font-weight: 700;
}
.inbox-item p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.inbox-item.active h4, .inbox-item.active p {
    color: #fff;
}

.inbox-detail {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
}
.inbox-detail .detail-header {
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
    margin-bottom: 20px;
}
.inbox-detail .detail-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

/* == P√ÅGINA: CLIENTES Y PAGOS == */
.table-container {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow-x: auto;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
}
thead th {
    background-color: var(--bg-dark-main);
    color: var(--text-primary);
    font-size: 0.9rem;
    text-transform: uppercase;
}
tbody tr:hover {
    background-color: var(--bg-dark-main);
}
tbody td {
    font-size: 0.95rem;
}
tbody td:first-child {
    color: var(--text-primary);
    font-weight: 500;
}
td .btn {
    padding: 5px 10px;
    font-size: 0.8rem;
}

/* == P√ÅGINA: GESTIONAR PLANTILLAS == */
.page-header {
.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
.template-card {
    background-color: var(--bg-dark-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}
}
.template-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
    background-color: #555; /* Placeholder */
.template-content {
    padding: 20px;
}
.template-content p {
    font-size: 0.9rem;
    margin-bottom: 15px;
}
.template-actions {
    padding: 0 20px 20px 20px;
    display: flex;
    gap: 10px;
}
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
#templateEditModal .form-control {
    background-color: var(--bg-dark-main);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}
#templateEditModal .form-control::placeholder { color: var(--text-secondary); }
#templateEditModal .form-label { color: var(--text-secondary); font-weight: 500; }
#templateEditModal .modal-header, #templateEditModal .modal-footer { border-color: var(--border-color); }
#templateEditModal .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
#templateEditModal .btn-secondary { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
#templateEditImagePreview.template-preview-img { max-width:200px; display:none; border-radius:6px; border:1px solid var(--border-color); margin-top:8px; }

/* preview image for public template editor */
#publicTplImagePreview { max-width:200px; display:none; border-radius:6px; border:1px solid var(--border-color); margin-top:8px; }

/* Sombreado del backdrop un poco m√°s oscuro para resaltar el modal */
.modal-backdrop.show { background-color: rgba(0,0,0,0.65); }

/* Icon indicator for inbox items (with fade transitions) */
.icon-indicator { display:inline-block; width:1.2em; text-align:center; margin-right:6px; transition: opacity .25s ease; }
.icon-fade-out { opacity: 0; }
.icon-fade-in { opacity: 1; }

/* Estilos oscuros espec√≠ficos para el modal de respuesta (replyModal) */
#replyModal .modal-content {
    background-color: var(--bg-dark-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}
#replyModal .modal-header, #replyModal .modal-footer { border-color: var(--border-color); }
#replyModal .modal-header .modal-title { color: var(--text-primary); font-weight:700; }
#replyModal .modal-body { color: var(--text-secondary); }
#replyModal .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
#replyModal .btn-outline-success { color: var(--green); border-color: rgba(40,167,69,0.15); background: transparent; }
#replyModal a.btn-outline-success:hover { background-color: rgba(40,167,69,0.06); }
#replyModal .text-muted { color: var(--text-secondary) !important; }
#replyModal .modal-body .small { color: var(--text-secondary); }
        
/* == Estilos para el Modal de edici√≥n de secciones (sectionEditModal) == */
#sectionEditModal .modal-content {
    background-color: var(--bg-dark-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 40px rgba(0,0,0,0.6);
}
#sectionEditModal .modal-header, #sectionEditModal .modal-footer { border-color: var(--border-color); }
#sectionEditModal .form-control, #sectionEditModal textarea {
    background-color: var(--bg-dark-main);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}
#sectionEditModal .form-control::placeholder { color: var(--text-secondary); opacity: 0.85; }
#sectionEditModal .form-label { color: var(--text-secondary); font-weight:600; }
#sectionEditModal .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
#sectionEditModal .btn-secondary { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }

/* Hacer el selector objetivo m√°s visible */
#sectionEditSelector { color: var(--primary-blue); font-weight:700; }

/* == MODALES: aplicar tema oscuro por defecto (coincide con el panel) == */
.modal-content {
    background-color: var(--bg-dark-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
}
.modal-header, .modal-footer { border-color: var(--border-color) !important; }
.modal-body { color: var(--text-secondary); }
.modal .form-control,
.modal .form-select,
.modal textarea {
    background-color: var(--bg-dark-main) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color) !important;
}
.modal .form-control::placeholder { color: var(--text-secondary) !important; opacity: 0.9; }
.modal .btn-close { filter: invert(1) !important; opacity: 0.95; }
.modal .btn-primary { background-color: var(--primary-blue) !important; border-color: var(--primary-blue) !important; }
.modal .btn-secondary { background-color: transparent !important; color: var(--text-secondary) !important; border: 1px solid var(--border-color) !important; }
.modal .modal-dialog { max-width: 880px; }


/* Estilos para la lista de edici√≥n p√∫blica: mayor contraste y bloques visibles */
.public-edit-list .mb-2 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 8px 12px;
    border-radius: 8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid var(--border-color);
    margin-bottom: 8px;
}
.public-edit-list .mb-2 div { color: var(--text-primary); font-weight:600; }
.public-edit-list .edit-public-btn {
    min-width: 78px;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02);
    color: var(--text-primary);
}
.public-edit-list .edit-public-btn:hover { background: rgba(255,255,255,0.04); }
.public-edit-list .form-text { color: var(--text-secondary); margin-top: 6px; }

/* ==== Ajustes: Formularios de Configuraci√≥n ==== */
/* Limitar ancho de los formularios y centrar dentro de la tarjeta */
.config-form {
    max-width: 560px; /* ajustar este valor para hacerlo m√°s angosto o ancho */
    margin-left: 30px;
    margin-right: 30px;
    padding: 0 8px; /* peque√±o padding interno para m√≥viles */
}
.config-form .form-control,
.config-form .form-select {
    width: 80%; /* hacer los campos m√°s estrechos */
    box-sizing: border-box;
}
.config-form .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-start; /* cambiar a flex-end si prefieres botones a la derecha */
    margin-top: 10px;
}
@media (max-width: 500px) { /* Ajustes para pantallas muy peque√±as */
    .config-form { max-width: 100%; padding: 0 12px; } /* padding m√°s grande en m√≥viles */
}
/* Grid para las tarjetas de configuraci√≥n: 2 columnas, cajas cuadradas */
#page-configuracion .config-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
    align-items: start;
}
#page-configuracion .config-card {
    aspect-ratio: 1 / 1; /* caja cuadrada */
    padding: 18px; 
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    overflow: auto; 
}
/* Hacer que el contenido del formulario ocupe 100% del ancho dentro de la tarjeta */
#page-configuracion .config-card .config-form { width: 100%; }
@media (max-width: 900px) {
    #page-configuracion .config-grid { grid-template-columns: 1fr; }
    #page-configuracion .config-card { aspect-ratio: auto; }
}
    /* Estilos para bot√≥n de editar secci√≥n */
    .config-card { position: relative; }
    .config-card .card-actions { position: absolute; top: 16px; right: 16px; }
    .config-card .card-actions .edit-section-btn { padding: 6px 8px; }
    .section-edit-textarea { font-family: monospace; }

    /* Mejorar contraste y legibilidad dentro de las tarjetas de Configuraci√≥n */
    #page-configuracion .config-card h3 {
        color: var(--text-primary);
        font-weight: 700;
    }
    #page-configuracion .config-card .form-label,
    #page-configuracion .config-card label,
    #page-configuracion .config-card .form-check-label {
        color: var(--text-primary);
        opacity: 0.95;
        font-weight: 600;
    }

    /* Asegurar que el texto dentro de los inputs sea oscuro y legible
       (los inputs mantienen fondo claro por Bootstrap) */
    #page-configuracion .config-card .form-control,
    #page-configuracion .config-card .form-select {
        color: #111;
    }

    /* Placeholder menos apagado para que se lea mejor */
    #page-configuracion .config-card .form-control::placeholder {
        color: #6c757d; /* gris medio */
        opacity: 1;
    }

    /* Aumentar contraste del bot√≥n de editar (si se desea) */
    #page-configuracion .config-card .card-actions .edit-section-btn {
        color: var(--text-primary);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.03);
    }

    /* Mensajes y peque√±as ayudas en color claro */
    #page-configuracion .config-card .form-text,
    #page-configuracion .config-card .small,
    #page-configuracion .config-card .text-muted {
        color: var(--text-secondary);
        opacity: 0.95;
    }

    </style>
</head>
<body>

    <div class="admin-panel">
        
        <aside class="sidebar">
            <h2>AquaLink Devs</h2>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-page="dashboard">üè† Dashboard</a></li>
                    <li><a href="#" class="nav-link" data-page="clientes">üë§ Clientes</a></li>
                    <li><a href="#" class="nav-link" data-page="solicitudes">üì¨ Solicitudes</a></li>
                    <li><a href="#" class="nav-link" data-page="plantillas">üìë Plantillas</a></li>
                    <li><a href="#" class="nav-link" data-page="configuracion">‚öôÔ∏è Configuraci√≥n</a></li>
                    <li><a href="#" data-site="principal" data-type="publica" class="nav-link" data-page="logout">Volver</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            
            <header class="main-header">
                <input type="search" placeholder="Buscar cliente, plantilla...">
                <div class="profile">JA</div>
            </header>

            <div class="page active" id="page-dashboard">
                <h2>Dashboard</h2>
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h3>Ingresos (MRR)</h3>
                        <p class="kpi-value">$10.000</p>
                        <p class="kpi-change">+15% vs. mes anterior</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Clientes Activos</h3>
                        <p class="kpi-value">2</p>
                        <p class="kpi-change">+2 este mes</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Nuevas Solicitudes</h3>
                        <p class="kpi-value">3</p>
                        <p class="kpi-change">Sin leer</p>
                    </div>
                    <div class="kpi-card">
                        <h3>Tasa de Abandono</h3>
                        <p class="kpi-value">1.2%</p>
                        <p class="kpi-change negative">-0.5% vs. mes anterior</p>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Ingresos (√öltimos 6 Meses)</h3>
                        <p class="chart-placeholder">[Gr√°fico de barras de ingresos ir√≠a aqu√≠]</p>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Inter√©s por Plantilla</h3>
                        <p class="chart-placeholder">[Gr√°fico de dona ir√≠a aqu√≠]</p>
                        <canvas id="templateChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Modal: Editor de Secciones (Admin / P√∫blico) -->
            <div class="modal fade" id="sectionEditModal" tabindex="-1" aria-labelledby="sectionEditLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="sectionEditLabel">Editar Secci√≥n</h5>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="sectionEditId">
                            <div class="mb-3">
                                <label class="form-label">Modo de edici√≥n</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="sectionEditMode" id="modeContent" value="content" checked>
                                        <label class="form-check-label" for="modeContent">Contenido (HTML)</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="sectionEditMode" id="modeAttr" value="attr">
                                        <label class="form-check-label" for="modeAttr">Atributo (src / href / action / alt)</label>
                                    </div>
                                </div>
                            </div>
                            <div id="contentEditorArea" class="mb-3">
                                <label for="sectionEditContent" class="form-label">Contenido HTML</label>
                                <textarea id="sectionEditContent" class="form-control" rows="8" placeholder="Pega HTML aqu√≠ (p√°rrafos, t√≠tulos, listas)"></textarea>
                            </div>
                            <div id="attrEditorArea" class="d-none">
                                <div class="mb-3">
                                    <label for="sectionEditAttrName" class="form-label">Atributo</label>
                                    <input id="sectionEditAttrName" class="form-control" placeholder="Ej: src, href, alt, action">
                                </div>
                                <div class="mb-3">
                                    <label for="sectionEditAttrValue" class="form-label">Valor del Atributo</label>
                                    <input id="sectionEditAttrValue" class="form-control" placeholder="Pega la URL o valor del atributo aqu√≠">
                                </div>
                                <div class="form-text">Este modo guardar√° un objeto JSON en localStorage y la p√°gina p√∫blica aplicar√° el atributo a todos los elementos que coincidan con el selector objetivo.</div>
                            </div>
                            <div class="form-text mt-2">Selector objetivo (solo referencia): <code id="sectionEditSelector" class="text-monospace"></code></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="sectionEditSave">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
                    <!-- Modal: Editar Plantilla -->
                    <div class="modal fade" id="templateEditModal" tabindex="-1" aria-labelledby="templateEditLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="templateEditLabel">Editar Plantilla</h5>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                                <div class="modal-body">
                                    <form id="templateEditForm">
                                        <input type="hidden" id="templateEditId">
                                        <div class="mb-3">
                                            <label for="templateEditName" class="form-label">Nombre de la Plantilla</label>
                                            <input type="text" id="templateEditName" class="form-control" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="templateEditDesc" class="form-label">Descripci√≥n</label>
                                            <textarea id="templateEditDesc" class="form-control" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="templateEditImage" class="form-label">Cambiar imagen (opcional)</label>
                                            <input type="file" id="templateEditImage" accept="image/*" class="form-control">
                                            <div class="mt-2"><img id="templateEditImagePreview" src="" alt="Preview" class="template-preview-img"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Links de demo</label>
                                            <input type="url" id="templateEditDemoLogin" class="form-control mb-2" placeholder="Link: Inicio de sesi√≥n (ej. /login)">
                                            <input type="url" id="templateEditDemoMain" class="form-control mb-2" placeholder="Link: P√°gina principal (ej. /)">
                                            <input type="url" id="templateEditDemoAdmin" class="form-control" placeholder="Link: Administraci√≥n (ej. /admin)">
                                        </div>
                                        <div id="templateEditMessage" class="alert d-none" role="alert"></div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button type="button" class="btn btn-primary" id="templateEditSaveButton">Guardar cambios</button>
                                </div>
                            </div>
                        </div>
                    </div>


            <div class="page" id="page-solicitudes">
                <div class="page-header d-flex justify-content-between align-items-center mb-3">
                    <h2 class="m-0">Solicitudes</h2>
                    <div>
                        <button id="restoreRequestsBtn" class="btn btn-sm btn-secondary">Restaurar Solicitudes</button>
                    </div>
                </div>
                <div class="inbox-layout">
                    <div class="inbox-list">
                        <div class="inbox-item active">
                            <h4 class="unread">üü¢ Mar√≠a P√©rez</h4>
                            <p>Inter√©s: Plantilla LemusPool</p>
                        </div>
                        <div class="inbox-item">
                            <h4 class="unread">üü¢ Juan Gonz√°lez</h4>
                            <p>Inter√©s: Plantilla Arzopa Aqua</p>
                        </div>
                        <div class="inbox-item">
                            <h4 class="unread">üü¢ Carlos D√≠az</h4>
                            <p>Inter√©s: Plantilla Minimalista</p>
                        </div>
                        <div class="inbox-item">
                            <h4>‚ö´ Empresa Sol</h4>
                            <p>Consulta sobre soporte</p>
                        </div>
                    </div>
                    <div class="inbox-detail">
                        <div class="detail-header">
                            <h3>De: Mar√≠a P√©rez</h3>
                            <p>Correo: <a href="#">maria.p@email.com</a></p>
                            <p class="detail-template">Plantilla de Inter√©s: <strong>-</strong></p>
                        </div>
                        <div class="detail-body">
                            <p>
                                Hola, estoy interesada en la plantilla LemusPool. Se ve genial.
                                ¬øPodemos agendar una llamada para discutir c√≥mo adaptarla a mi negocio de piscinas?
                                <br><br>
                                Saludos.
                            </p>
                        </div>
                        <div class="detail-actions">
                            <button class="btn btn-secondary">Marcar Le√≠do</button>
                            <button class="btn btn-secondary">Archivar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="page-clientes">
                <h2>Clientes y Pagos</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th>Plan (Plantilla)</th>
                                <th>Tipo</th>
                                <th>Cantidad pagada</th>
                                <th>Pr√≥ximo Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-client-id="c1" data-name="Mar√≠a P√©rez" data-status="Activo" data-template="Plantilla LemusPool" data-payment-method="Tarjeta" data-amount="1200" data-next-payment="01/11/2026">
                                <td>Mar√≠a P√©rez</td>
                                <td><span class="status status-active">Activo</span></td>
                                <td>Plantilla LemusPool</td>
                                <td>Anual</td>
                                <td>$1,200</td>
                                <td>01/11/2026</td>
                                <td><button class="btn btn-secondary btn-view-client">Ver Detalles</button></td>
                            </tr>
                            <tr data-client-id="c2" data-name="Juan Gonz√°lez" data-status="Activo" data-template="Plantilla Arzopa Aqua" data-payment-method="Transferencia" data-amount="100" data-next-payment="15/11/2025">
                                <td>Juan Gonz√°lez</td>
                                <td><span class="status status-active">Activo</span></td>
                                <td>Plantilla Arzopa Aqua</td>
                                <td>Mensual</td>
                                <td>$100</td>
                                <td>15/11/2025</td>
                                <td><button class="btn btn-secondary btn-view-client">Ver Detalles</button></td>
                            </tr>
                            <tr data-client-id="c3" data-name="Empresa Sol" data-status="Atrasado" data-template="Plantilla LemusPool" data-payment-method="Carga Manual" data-amount="0" data-next-payment="01/11/2025">
                                <td>Empresa Sol</td>
                                <td><span class="status status-late">Atrasado</span></td>
                                <td>Plantilla LemusPool</td>
                                <td>Mensual</td>
                                <td>$0</td>
                                <td>01/11/2025</td>
                                <td><button class="btn btn-secondary btn-view-client">Ver Detalles</button></td>
                            </tr>
                            <tr data-client-id="c4" data-name="Carlos D√≠az" data-status="Pendiente" data-template="Plantilla Minimalista" data-payment-method="Pendiente" data-amount="0" data-next-payment="-">
                                <td>Carlos D√≠az</td>
                                <td><span class="status status-pending">Pendiente</span></td>
                                <td>Plantilla Minimalista</td>
                                <td>-</td>
                                <td>$0</td>
                                <td>-</td>
                                <td><button class="btn btn-secondary btn-view-client">Ver Detalles</button></td>
                            </tr>
                            <tr data-client-id="c5" data-name="Cliente Antiguo" data-status="Cancelado" data-template="Plantilla Minimalista" data-payment-method="Tarjeta" data-amount="0" data-next-payment="-">
                                <td>Cliente Antiguo</td>
                                <td><span class="status status-canceled">Cancelado</span></td>
                                <td>Plantilla Minimalista</td>
                                <td>Mensual</td>
                                <td>$0</td>
                                <td>-</td>
                                <td><button class="btn btn-secondary btn-view-client">Ver Detalles</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="page" id="page-plantillas">
                <div class="page-header">
                    <h2>Gestionar Plantillas</h2>
                    <button class="btn btn-primary">+ A√±adir Nueva Plantilla</button>
                </div>
                
                <div class="template-grid">
                    <div class="template-card" data-template-id="tmpl-lemuspool">
                        <img src="../Image/lemuspool.jfif" alt="LemusPool">
                        <div class="template-content">
                            <h4>Plantilla LemusPool</h4>
                            <p>Un dise√±o elegante y completo, ideal para mostrar tus instalaciones.</p>
                            <span class="status status-published">Publicada</span>
                            <span> | 2 Clientes Activos</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Ocultar</button>
                        </div>
                    </div>
                    <div class="template-card" data-template-id="tmpl-arzopa">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrHmKit7scCP3ikRIUdEYwKcH6SNllCtpvqQ&s" alt="Arzopa Aqua">
                        <div class="template-content">
                            <h4>Plantilla Arzopa Aqua</h4>
                            <p>Un dise√±o vibrante y moderno inspirado en la naturaleza.</p>
                            <span class="status status-published">Publicada</span>
                            <span> | 1 Cliente Activo</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Ocultar</button>
                        </div>
                    </div>
                    <div class="template-card" data-template-id="tmpl-minimalist">
                        <img src="../Image/minimalist.jpg" alt="Minimalista">
                        <div class="template-content">
                            <h4>Plantilla Minimalista</h4>
                            <p>Un dise√±o limpio y moderno con mucho espacio en blanco.</p>
                            <span class="status status-published">Publicada</span>
                            <span> | 1 Cliente Activo</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Ocultar</button>
                        </div>
                    </div>
                    <div class="template-card" data-template-id="tmpl-retro">
                        <img src="https://media-cdn.tripadvisor.com/media/photo-s/10/11/cb/b0/photo0jpg.jpg" alt="Borrador">
                        <div class="template-content">
                            <h4>Plantilla Retro</h4>
                            <p>Nueva plantilla en desarrollo para clientes corporativos.</p>
                            <span class="status status-draft">Oculta (Borrador)</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Publicar</button>
                        </div>
                    </div>
                    <!-- Plantillas adicionales copiadas desde pagina_principal.html -->
                    <div class="template-card" data-template-id="tmpl-tropical">
                        <img src="https://i.pinimg.com/564x/7f/7a/55/7f7a555a10301e802999e27b89261ace.jpg" alt="Tropical">
                        <div class="template-content">
                            <h4>Plantilla Tropical</h4>
                            <p>Vibrante y divertida, con colores vivos y un dise√±o org√°nico y redondeado. Perfecta para un ambiente de para√≠so y diversi√≥n.</p>
                            <span class="status status-published">Publicada</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Ocultar</button>
                        </div>
                    </div>

                    <div class="template-card" data-template-id="tmpl-luxury">
                        <img src="https://content.revistainteriores.es/medio/2023/12/12/piscinas-de-estilo-santorini_1da4a371_118_231212150836_730x808.jpg" alt="Resort de Lujo">
                        <div class="template-content">
                            <h4>Plantilla Resort de Lujo</h4>
                            <p>Un tema oscuro y sofisticado que usa tipograf√≠a serif y detalles en tonos dorados para una m√°xima sensaci√≥n de exclusividad.</p>
                            <span class="status status-published">Publicada</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Ocultar</button>
                        </div>
                    </div>

                    <div class="template-card" data-template-id="tmpl-family">
                        <img src="https://piscinasdtp.com/wp-content/uploads/2025/07/Rectangle-111-17.webp" alt="Familiar">
                        <div class="template-content">
                            <h4>Plantilla Familiar</h4>
                            <p>Dise√±o alegre con colores primarios, √≠conos y una estructura clara, pensada para ser atractiva y f√°cil de usar para padres y ni√±os.</p>
                            <span class="status status-published">Publicada</span>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-primary btn-edit-template">Editar</button>
                            <button class="btn btn-secondary">Ocultar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="page-configuracion">
                <h2>Configuraci√≥n</h2>

                <div class="config-grid">

                <div class="card config-card" data-section-id="account">
                    <h3>Configuraci√≥n de la Cuenta</h3>
                    <form id="adminAccountForm" class="config-form">
                        <div class="mb-3">
                            <label for="cfgAdminEmail" class="form-label">Email de Administrador</label>
                            <input type="email" id="cfgAdminEmail" class="form-control" placeholder="admin@tusitio.com" required>
                        </div>
                        <div class="mb-3">
                            <label for="cfgCurrentPassword" class="form-label">Contrase√±a Actual (opcional)</label>
                            <input type="password" id="cfgCurrentPassword" class="form-control" placeholder="Contrase√±a actual">
                        </div>
                        <div class="mb-3">
                            <label for="cfgNewPassword" class="form-label">Nueva Contrase√±a</label>
                            <input type="password" id="cfgNewPassword" class="form-control" placeholder="Nueva contrase√±a">
                        </div>
                        <div class="mb-3">
                            <label for="cfgNewPasswordConfirm" class="form-label">Confirmar Nueva Contrase√±a</label>
                            <input type="password" id="cfgNewPasswordConfirm" class="form-control" placeholder="Confirmar nueva contrase√±a">
                        </div>
                        <div id="accountConfigMessage" class="alert d-none" role="alert"></div>
                        <div class="form-actions">
                            <button type="button" id="saveAccountConfig" class="btn btn-primary">Guardar cambios</button>
                        </div>
                    </form>
                </div>

                <div class="card config-card" data-section-id="site">
                    <h3>Ajustes del Sitio</h3>
                    <form id="siteSettingsForm" class="config-form">
                        <div class="mb-3">
                            <label for="siteTitle" class="form-label">T√≠tulo del Sitio</label>
                            <input type="text" id="siteTitle" class="form-control" placeholder="LemusPool - Plantillas para piscinas">
                        </div>
                        <div class="mb-3">
                            <label for="defaultTemplate" class="form-label">Plantilla por defecto</label>
                            <select id="defaultTemplate" class="form-select">
                                <option value="">-- Seleccionar --</option>
                                <option value="tmpl-lemuspool">LemusPool</option>
                                <option value="tmpl-arzopa">Arzopa Aqua</option>
                                <option value="tmpl-minimalist">Minimalista</option>
                                <option value="tmpl-retro">Retro</option>
                                <option value="tmpl-tropical">Tropical</option>
                                <option value="tmpl-luxury">Resort de Lujo</option>
                                <option value="tmpl-family">Familiar</option>
                            </select>
                        </div>
                        <div id="siteSettingsMessage" class="alert d-none" role="alert"></div>
                        <div class="form-actions">
                            <button type="button" id="saveSiteSettings" class="btn btn-primary">Guardar ajustes</button>
                        </div>
                    </form>
                </div>

                <div class="card config-card" data-section-id="notifications">
                    <h3>Notificaciones</h3>
                    <form id="notificationsForm" class="config-form">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="notifyNewRequests">
                            <label class="form-check-label" for="notifyNewRequests">Notificar por nuevas solicitudes</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="notifyLowBalance">
                            <label class="form-check-label" for="notifyLowBalance">Notificar cuando clientes tengan pagos atrasados</label>
                        </div>
                        <div id="notificationsMessage" class="alert d-none" role="alert"></div>
                        <div class="form-actions">
                            <button type="button" id="saveNotifications" class="btn btn-primary">Guardar notificaciones</button>
                        </div>
                    </form>
                </div>

                <div class="card config-card" data-section-id="smtp">
                    <h3>SMTP / Correo</h3>
                    <form id="smtpForm" class="config-form">
                        <div class="mb-3">
                            <label for="smtpHost" class="form-label">Host SMTP</label>
                            <input type="text" id="smtpHost" class="form-control" placeholder="smtp.example.com">
                        </div>
                        <div class="mb-3">
                            <label for="smtpPort" class="form-label">Puerto</label>
                            <input type="number" id="smtpPort" class="form-control" placeholder="587">
                        </div>
                        <div class="mb-3">
                            <label for="smtpUser" class="form-label">Usuario SMTP</label>
                            <input type="text" id="smtpUser" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="smtpPass" class="form-label">Contrase√±a SMTP</label>
                            <input type="password" id="smtpPass" class="form-control">
                        </div>
                        <div id="smtpMessage" class="alert d-none" role="alert"></div>
                        <div class="form-actions">
                            <button type="button" id="saveSmtpConfig" class="btn btn-primary">Guardar configuraci√≥n de correo</button>
                        </div>
                    </form>
                    <small class="text-muted">Nota: Los cambios de SMTP solo se guardan localmente. Para persistir en el servidor, a√±adir endpoint PHP.</small>
                </div>

                

            </div>

        </main>
    </div>

    <!-- Modal: Editor P√∫blico de Plantillas (imagen, nombre, descripci√≥n, links) -->
    <div class="modal fade" id="publicTemplateEditModal" tabindex="-1" aria-labelledby="publicTemplateEditLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="publicTemplateEditLabel">Editar Plantilla P√∫blica</h5>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                <div class="modal-body">
                    <form id="publicTemplateForm">
                        <div class="mb-3">
                            <label class="form-label">Seleccionar Plantilla</label>
                            <select id="publicTemplateSelect" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label for="publicTplName" class="form-label">Nombre de la Plantilla</label>
                            <input type="text" id="publicTplName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="publicTplDesc" class="form-label">Descripci√≥n</label>
                            <textarea id="publicTplDesc" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="publicTplImage" class="form-label">Cambiar imagen (opcional)</label>
                            <input type="file" id="publicTplImage" accept="image/*" class="form-control">
                            <div class="mt-2"><img id="publicTplImagePreview" src="" alt="Preview"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Links de demo</label>
                            <input type="url" id="publicTplDemoLogin" class="form-control mb-2" placeholder="Link: Inicio de sesi√≥n (ej. /login)">
                            <input type="url" id="publicTplDemoMain" class="form-control mb-2" placeholder="Link: P√°gina principal (ej. /)">
                            <input type="url" id="publicTplDemoAdmin" class="form-control" placeholder="Link: Administraci√≥n (ej. /admin)">
                        </div>
                        <div id="publicTplMessage" class="alert d-none" role="alert"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="publicTplSaveButton">Guardar cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Responder Solicitud (Simplificado)  -->
    <div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="replyModalLabel">Respuesta Solicitud</h5>
                </div>
                <div class="modal-body text-center">
                    <hr>

                    <div class="mb-2">
                        <button id="openGmailBtn" class="btn btn-primary btn-sm">Abrir Gmail (Componer)</button>
                    </div>
                    <div>
                        <a id="replyPhoneLink" href="#" class="btn btn-outline-success btn-sm">Llamar</a>
                    </div>
                    <div class="mt-2 text-muted small" id="replyEmailDisplay"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>


    <!-- Modal y JS para gestionar solicitudes de restablecimiento (admin) -->
    <div class="modal fade" id="adminResetModal" tabindex="-1" aria-labelledby="adminResetLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminResetLabel">Restablecer Contrase√±a (Admin)</h5>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                <div class="modal-body">
                    <form id="adminResetForm">
                        <input type="hidden" id="adminResetRequestId">
                        <div class="mb-3">
                            <label for="adminResetEmail" class="form-label">Email del Usuario</label>
                            <input type="email" class="form-control" id="adminResetEmail" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="adminNewPassword" class="form-label">Nueva Contrase√±a</label>
                            <input type="password" class="form-control" id="adminNewPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminNewPasswordConfirm" class="form-label">Confirmar Contrase√±a</label>
                            <input type="password" class="form-control" id="adminNewPasswordConfirm" required>
                        </div>
                        <div id="adminResetMessage" class="alert d-none" role="alert"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="adminSavePasswordButton">Guardar contrase√±a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Detalle Cliente / Pagos -->
    <div class="modal fade" id="clientDetailModal" tabindex="-1" aria-labelledby="clientDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientDetailLabel">Detalle Cliente</h5>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                <div class="modal-body">
                    <form id="clientDetailForm">
                        <input type="hidden" id="clientDetailId">
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" id="clientDetailName" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Plantilla</label>
                            <input type="text" id="clientDetailTemplate" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Forma de pago</label>
                            <input type="text" id="clientDetailPaymentMethod" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cantidad pagada</label>
                            <input type="text" id="clientDetailAmount" class="form-control" placeholder="$0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pr√≥ximo Pago</label>
                            <input type="text" id="clientDetailNextPayment" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Estado</label>
                            <select id="clientDetailStatus" class="form-select">
                                <option value="Activo">Activo</option>
                                <option value="Atrasado">Atrasado</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div id="clientDetailMessage" class="alert d-none" role="alert"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="clientDetailSave">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../Direccion/controlador.js"></script>

    <!-- Bootstrap JS (incluye Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Dashboard charts: usar datos desde localStorage (clients_data, templates) -->
    <script>
    document.addEventListener('DOMContentLoaded', function(){
        // Forzar color de texto global de Chart.js a blanco para visibilidad
        try {
            if (window.Chart && Chart.defaults) {
                Chart.defaults.font.family = "'Inter', system-ui, Arial";
                Chart.defaults.color = '#ffffff';
            }
        } catch(e) { console.warn('Chart defaults not applied', e); }

        // Reescribe llamadas fetch que usen rutas absolutas a /vendedor/php/
        // (esto evita 404 cuando el sitio est√° servido en un subdirectorio de XAMPP)
        try {
            if (typeof window.fetch === 'function') {
                const _fetch = window.fetch.bind(window);
                window.fetch = function(input, init) {
                    try {
                        if (typeof input === 'string' && input.indexOf('/vendedor/php/') === 0) {
                            input = input.replace('/vendedor/php/', '../php/');
                        }
                    } catch(err) { /* ignore */ }
                    return _fetch(input, init);
                };
            }
        } catch(e) { console.warn('No pude aplicar fetch-rewrite', e); }
        // Utilidades
        function lastNMonthsLabels(n) {
            const labels = [];
            const now = new Date();
            for (let i = n - 1; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(d.toLocaleString('default', { month: 'short', year: 'numeric' }));
            }
            return labels;
        }

        // Cargar clientes desde localStorage (fallback: parse tabla DOM)
        let clients = [];
        try { clients = JSON.parse(localStorage.getItem('clients_data') || 'null') || []; } catch(e){ clients = []; }
        if (!clients || !Array.isArray(clients) || clients.length === 0) {
            // fallback: extraer desde la tabla en DOM
            clients = [];
            document.querySelectorAll('#page-clientes table tbody tr').forEach(tr => {
                const id = tr.dataset.clientId || null;
                const name = tr.dataset.name || tr.children[0]?.textContent.trim() || '';
                const status = tr.dataset.status || '';
                const template = tr.dataset.template || tr.children[2]?.textContent.trim() || '';
                const amountRaw = tr.dataset.amount || tr.children[4]?.textContent.trim() || '0';
                const amount = Number(String(amountRaw).replace(/[^0-9.\-]/g,'')) || 0;
                const nextPayment = tr.dataset.nextPayment || tr.children[5]?.textContent.trim() || '';
                clients.push({ id, name, status, template, amountPaid: amount, nextPayment });
            });
        }

        // Revenue chart: √∫ltimos 6 meses
        const months = lastNMonthsLabels(6);
        const revenueData = new Array(months.length).fill(0);
        const now = new Date();
        clients.forEach(c => {
            let amt = 0;
            if (c.amountPaid !== undefined && c.amountPaid !== null) amt = Number(c.amountPaid) || 0;
            else if (c.amount !== undefined) amt = Number(c.amount) || 0;
            // nextPayment puede estar en formato dd/mm/yyyy o ISO
            let idx = -1;
            if (c.nextPayment) {
                // intentar parseo ISO primero
                let parsed = new Date(c.nextPayment);
                if (isNaN(parsed)) {
                    // intentar formato dd/mm/yyyy
                    const parts = c.nextPayment.split(/[^0-9]/).filter(Boolean);
                    if (parts.length >= 3) {
                        const day = parseInt(parts[0],10), month = parseInt(parts[1],10)-1, year = parseInt(parts[2],10);
                        parsed = new Date(year, month, day);
                    }
                }
                if (!isNaN(parsed)) {
                    const monthsDiff = (parsed.getFullYear() - now.getFullYear())*12 + (parsed.getMonth() - now.getMonth());
                    const relativeIdx = (months.length - 1) + monthsDiff; // 0..months.length-1
                    if (relativeIdx >= 0 && relativeIdx < months.length) idx = relativeIdx;
                }
            }
            // si no tenemos nextPayment, sumar al mes actual
            if (idx === -1) idx = months.length - 1;
            revenueData[idx] = (revenueData[idx] || 0) + amt;
        });

        // Dibujar revenueChart (barras)
        const revCtx = document.getElementById('revenueChart');
        if (revCtx) {
            new Chart(revCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Ingresos (ARS)',
                        data: revenueData,
                        backgroundColor: 'rgba(0,123,255,0.7)',
                        borderColor: 'rgba(0,123,255,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#ffffff' } },
                        y: { beginAtZero: true, ticks: { color: '#ffffff', callback: function(value){ return value >= 1000 ? '$' + value.toLocaleString() : '$' + value; } } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { titleColor: '#ffffff', bodyColor: '#ffffff' }
                    }
                }
            });
        }

        // Template interest chart (doughnut)
        const templateCounts = {};
        clients.forEach(c => {
            const tpl = (c.template || c.template_id || c.plan || 'Sin plantilla').toString().trim();
            if (!tpl) return;
            templateCounts[tpl] = (templateCounts[tpl] || 0) + 1;
        });

        const tplLabels = Object.keys(templateCounts);
        const tplValues = tplLabels.map(k => templateCounts[k]);
        const colors = [
            '#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#20c997','#fd7e14'
        ];

        const tplCtx = document.getElementById('templateChart');
        if (tplCtx) {
            new Chart(tplCtx, {
                type: 'doughnut',
                data: {
                    labels: tplLabels,
                    datasets: [{ data: tplValues, backgroundColor: tplLabels.map((_,i)=>colors[i%colors.length]) }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ffffff', boxWidth: 18, boxHeight: 12 } },
                        tooltip: { titleColor: '#ffffff', bodyColor: '#ffffff' }
                    }
                }
            });
        }
    });
    </script>

    <script>
    // Consolidated JS: navigation, solicitudes, templates, config, section editor

    // --- Navegaci√≥n de p√°ginas ---
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        const pages = document.querySelectorAll('.main-content .page');

        function changePage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            navLinks.forEach(link => link.classList.remove('active'));
            const targetPage = document.getElementById('page-' + pageId);
            if (targetPage) targetPage.classList.add('active');
            const targetLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
            if (targetLink) targetLink.classList.add('active');
        }

        navLinks.forEach(link => link.addEventListener('click', function(event) {
            const pageId = this.getAttribute('data-page');
            if (pageId === 'logout') return;
            event.preventDefault();
            changePage(pageId);
        }));
    });

    // --- Solicitudes / Reset requests ---
    function getResetRequests() { try { const raw = localStorage.getItem('password_reset_requests'); return raw ? JSON.parse(raw) : []; } catch (e) { console.error(e); return []; } }
    function saveResetRequests(list) { try { localStorage.setItem('password_reset_requests', JSON.stringify(list)); } catch (e) { console.error(e); } }
    function renderResetRequests() {
        const list = getResetRequests();
        const inboxListEl = document.querySelector('#page-solicitudes .inbox-list');
        if (inboxListEl) {
            inboxListEl.querySelectorAll('.inbox-item.dynamic-reset').forEach(el => el.remove());
            if (list.length > 0) {
                list.slice().reverse().forEach(req => {
                    if (req.archived) return;
                    const item = document.createElement('div');
                    item.className = 'inbox-item dynamic-reset' + (req.handled ? '' : ' unread');
                    item.dataset.reqId = req.id;
                    item.dataset.email = req.email;
                    item.dataset.message = req.message || '';
                    item.dataset.date = req.date;
                    const icon = req.handled ? '‚ö´' : 'üü¢';
                    item.innerHTML = `\n                            <h4 class="${req.handled ? '' : 'unread'}">${icon} ${req.email}</h4>\n                            <p>${req.message ? (req.message.substring(0, 80) + (req.message.length>80? '...':'')) : new Date(req.date).toLocaleString()}</p>\n                        `;
                    inboxListEl.insertBefore(item, inboxListEl.firstChild);
                });
            }
            attachInboxItemListeners();
            return;
        }
        let container = document.getElementById('passwordResetRequestsList');
        if (!container) {
            container = document.createElement('div');
            container.id = 'passwordResetRequestsList';
            container.className = 'container my-4';
            const heading = document.createElement('h4'); heading.textContent = 'Solicitudes de Restablecimiento de Contrase√±a';
            container.prepend(heading);
            const mensajesSection = document.getElementById('mensajes') || document.getElementById('reportes');
            if (mensajesSection && mensajesSection.parentNode) mensajesSection.parentNode.insertBefore(container, mensajesSection.nextSibling); else document.body.appendChild(container);
        }
        container.innerHTML = '';
        if (list.length === 0) { container.innerHTML = '<div class="text-muted">No hay solicitudes pendientes.</div>'; return; }
        list.slice().reverse().forEach(req => {
            const item = document.createElement('div'); item.className = 'list-group-item d-flex justify-content-between align-items-start';
            item.dataset.reqId = req.id;
            item.dataset.email = req.email || '';
            const left = document.createElement('div'); left.className = 'ms-2 me-auto';
            const icon2 = req.handled ? '‚ö´' : 'üü¢';
            left.innerHTML = `<div><strong><span class="icon-indicator">${icon2}</span> ${req.email}</strong> <small class="text-muted">(${new Date(req.date).toLocaleString()})</small></div>` + `<div class="text-muted">ID: ${req.id} ${req.handled ? '<span class="badge bg-success ms-2">Atendido</span>' : ''}</div>`;
            const right = document.createElement('div');
            if (!req.handled) { const btnReset = document.createElement('button'); btnReset.className = 'btn btn-sm btn-primary me-2'; btnReset.textContent = 'Restablecer'; btnReset.onclick = () => openAdminResetModal(req.id); right.appendChild(btnReset); const btnMark = document.createElement('button'); btnMark.className = 'btn btn-sm btn-outline-secondary'; btnMark.textContent = 'Marcar como atendido'; btnMark.onclick = () => { markRequestHandled(req.id); }; right.appendChild(btnMark); } else { const span = document.createElement('span'); span.className = 'text-success'; span.textContent = 'Atendido'; right.appendChild(span); }
            item.appendChild(left); item.appendChild(right); container.appendChild(item);
        });
    }

    let __currentRequestId = null;
    function openRequestDetailById(id) {
        const list = getResetRequests();
        const req = list.find(r => String(r.id) === String(id));
        const detailEl = document.querySelector('#page-solicitudes .inbox-detail'); if (!detailEl) return;
        __currentRequestId = id;
        if (req) {
            detailEl.querySelector('.detail-header h3').textContent = 'De: ' + (req.name || req.email);
            detailEl.querySelector('.detail-header p a').textContent = req.email; detailEl.querySelector('.detail-header p a').href = 'mailto:' + req.email;
            let plantPara = detailEl.querySelector('.detail-header .detail-template'); if (!plantPara) { plantPara = document.createElement('p'); plantPara.className = 'detail-template'; detailEl.querySelector('.detail-header').appendChild(plantPara); }
            plantPara.innerHTML = 'Plantilla de Inter√©s: <strong>' + (req.template || '-') + '</strong>';
            let phonePara = detailEl.querySelector('.detail-header .detail-phone'); if (!phonePara) { phonePara = document.createElement('p'); phonePara.className = 'detail-phone'; detailEl.querySelector('.detail-header').appendChild(phonePara); }
            phonePara.innerHTML = 'Tel√©fono: ' + (req.phone ? ('<a href="tel:' + req.phone + '">' + req.phone + '</a>') : '-');
            const gmailBtn = document.getElementById('detailGmailBtn'); if (gmailBtn) { gmailBtn.onclick = function(e) { e.preventDefault(); const to = req.email || ''; const subject = req.template ? ('Consulta sobre ' + req.template) : 'Respuesta desde LemusPool'; const body = 'Hola ' + (req.name || '') + ',%0A%0A'; const url = 'https://mail.google.com/mail/?view=cm&fs=1&to=' + encodeURIComponent(to) + '&su=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body); window.open(url, '_blank'); }; }
            const callBtn = document.getElementById('detailCallBtn'); if (callBtn) { if (req.phone) { callBtn.setAttribute('href', 'tel:' + req.phone); callBtn.style.pointerEvents = 'auto'; } else { callBtn.setAttribute('href', '#'); callBtn.style.pointerEvents = 'none'; } }
            detailEl.querySelector('.detail-body p').textContent = req.message || '(Sin mensaje)';
        } else {
            const item = document.querySelector('.inbox-item[data-req-id="' + id + '"]'); if (item) { __currentRequestId = item.dataset.reqId || null; detailEl.querySelector('.detail-header h3').textContent = 'De: ' + (item.querySelector('h4') ? item.querySelector('h4').textContent : 'Solicitud'); detailEl.querySelector('.detail-header p a').textContent = item.dataset.email || ''; detailEl.querySelector('.detail-body p').textContent = item.dataset.message || item.querySelector('p')?.textContent || ''; }
        }
        document.querySelectorAll('.inbox-list .inbox-item').forEach(el => el.classList.remove('active'));
        const sel = document.querySelector('.inbox-list .inbox-item[data-req-id="' + id + '"]'); if (sel) sel.classList.add('active');
    }

    function attachInboxItemListeners() {
        document.querySelectorAll('#page-solicitudes .inbox-list .inbox-item').forEach(item => {
            if (item.__listenerAttached) return; item.__listenerAttached = true;
            item.addEventListener('click', function() {
                const id = this.dataset.reqId || this.getAttribute('data-req-id') || null;
                if (id) { openRequestDetailById(id); this.classList.remove('unread'); try { markRequestHandled(Number(id)); } catch (e) {} } else { document.querySelectorAll('.inbox-list .inbox-item').forEach(el => el.classList.remove('active')); this.classList.add('active'); const detailEl = document.querySelector('#page-solicitudes .inbox-detail'); if (detailEl) { detailEl.querySelector('.detail-header h3').textContent = this.querySelector('h4') ? this.querySelector('h4').textContent : 'Solicitud'; detailEl.querySelector('.detail-body p').textContent = this.querySelector('p') ? this.querySelector('p').textContent : ''; } }
            });
        });
        const btnMark = document.querySelector('#page-solicitudes .detail-actions .btn-secondary'); if (btnMark) { btnMark.addEventListener('click', function() { if (__currentRequestId) markRequestHandled(Number(__currentRequestId)); }); }
        const btnArchive = document.querySelector('#page-solicitudes .detail-actions .btn-secondary:last-child'); if (btnArchive) { btnArchive.addEventListener('click', function() { if (__currentRequestId) markRequestArchived(Number(__currentRequestId)); }); }
        const btnReply = document.querySelector('#page-solicitudes .detail-actions .btn-primary'); if (btnReply) { btnReply.addEventListener('click', function() { if (__currentRequestId) openReplyModal(__currentRequestId); }); }
    }

    document.addEventListener('DOMContentLoaded', function(){ const btn = document.getElementById('restoreRequestsBtn'); if (btn) btn.addEventListener('click', function(){ restoreSampleResetRequests(); this.disabled = true; this.textContent = 'Restauradas'; }); try { const existing = getResetRequests(); if (!existing || existing.length === 0) { console.info('No hay solicitudes en localStorage: restaurando muestras.'); restoreSampleResetRequests(); } } catch (e) { console.warn('Comprobaci√≥n de solicitudes fall√≥', e); } });

    function openReplyModal(requestId) {
        const list = getResetRequests(); const req = list.find(r => String(r.id) === String(requestId)); let email = ''; let phone = ''; let subj = 'Respuesta desde LemusPool'; let body = '\n\n---\nMensaje original:\n'; let idVal = requestId || '';
        if (req) { email = req.email || ''; phone = req.phone || ''; subj = req.template ? ('Consulta sobre ' + req.template) : subj; body += (req.message || ''); idVal = req.id; } else { const detailEl = document.querySelector('#page-solicitudes .inbox-detail'); if (detailEl) { const emailAnchor = detailEl.querySelector('.detail-header p a'); email = emailAnchor ? emailAnchor.textContent.trim() : ''; const phonePara = detailEl.querySelector('.detail-header .detail-phone'); if (phonePara) { const a = phonePara.querySelector('a'); phone = a ? a.textContent.trim() : phonePara.textContent.replace(/Tel[e√©]fono:\s*/i, '').trim(); } const tplPara = detailEl.querySelector('.detail-header .detail-template'); if (tplPara) subj = 'Consulta sobre ' + (tplPara.textContent.replace(/Plantilla de Inter√©s:\s*/i, '').trim() || ''); const msgPara = detailEl.querySelector('.detail-body p'); if (msgPara) body += msgPara.textContent.trim(); } }
        document.getElementById('replyRequestId').value = idVal; document.getElementById('replyEmail').value = email; document.getElementById('replyPhone').value = phone; document.getElementById('replySubject').value = subj; document.getElementById('replyBody').value = body;
        const modalEl = document.getElementById('replyModal'); const modal = new bootstrap.Modal(modalEl, { backdrop: true }); modal.show();
    }

    function openGmailCompose(){ const to = document.getElementById('replyEmail').value || ''; const subject = document.getElementById('replySubject').value || ''; const body = document.getElementById('replyBody').value || ''; const url = 'https://mail.google.com/mail/?view=cm&fs=1&to=' + encodeURIComponent(to) + '&su=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body); window.open(url, '_blank'); }
    function openMailto(){ const to = document.getElementById('replyEmail').value || ''; const subject = document.getElementById('replySubject').value || ''; const body = document.getElementById('replyBody').value || ''; const mailto = 'mailto:' + encodeURIComponent(to) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body); window.open(mailto, '_self'); }
    document.addEventListener('DOMContentLoaded', function(){ const gbtn = document.getElementById('openGmailBtn'); if (gbtn) gbtn.addEventListener('click', openGmailCompose); const mbtn = document.getElementById('openMailtoBtn'); if (mbtn) mbtn.addEventListener('click', openMailto); });

    function markRequestArchived(id) { try { const list = getResetRequests(); const idx = list.findIndex(r => String(r.id) === String(id)); if (idx !== -1) { list[idx].archived = true; saveResetRequests(list); } renderResetRequests(); const detailEl = document.querySelector('#page-solicitudes .inbox-detail'); if (detailEl) { detailEl.querySelector('.detail-header h3').textContent = ''; detailEl.querySelector('.detail-body p').textContent = ''; } } catch (e) { console.error(e); } }

    // update icon indicator with fade animation for a given request id
    function updateInboxIcon(id, handled){
        try {
            const iconChar = handled ? '‚ö´' : 'üü¢';
            // inbox list item
            const item = document.querySelector('.inbox-item[data-req-id="' + id + '"]');
            if (item){
                const h4 = item.querySelector('h4');
                if (h4){
                    let iconSpan = h4.querySelector('.icon-indicator');
                    const email = item.dataset.email || (h4.textContent || '').replace(/^\S+\s+/, '').trim();
                    if (!iconSpan){
                        h4.innerHTML = '<span class="icon-indicator">' + iconChar + '</span> <span class="email-text">' + (email) + '</span>';
                    } else {
                        iconSpan.classList.add('icon-fade-out');
                        setTimeout(()=>{
                            iconSpan.textContent = iconChar;
                            iconSpan.classList.remove('icon-fade-out');
                            iconSpan.classList.add('icon-fade-in');
                            setTimeout(()=>{ iconSpan.classList.remove('icon-fade-in'); }, 300);
                        }, 180);
                    }
                }
            }
            // alternative container list (if present)
            const item2 = document.querySelector('.list-group-item[data-req-id="' + id + '"]');
            if (item2){
                const strong = item2.querySelector('strong');
                if (strong){
                    let iconSpan2 = strong.querySelector('.icon-indicator');
                    const email2 = item2.dataset.email || (strong.textContent || '').replace(/^\S+\s+/, '').trim();
                    if (!iconSpan2){
                        strong.innerHTML = '<span class="icon-indicator">' + iconChar + '</span> ' + (email2);
                    } else {
                        iconSpan2.classList.add('icon-fade-out');
                        setTimeout(()=>{
                            iconSpan2.textContent = iconChar;
                            iconSpan2.classList.remove('icon-fade-out');
                            iconSpan2.classList.add('icon-fade-in');
                            setTimeout(()=>{ iconSpan2.classList.remove('icon-fade-in'); }, 300);
                        }, 180);
                    }
                }
            }
        } catch(e){ console.error('updateInboxIcon', e); }
    }

    function restoreSampleResetRequests() { try { const samples = [ { id: Date.now()+1, name: 'Mar√≠a P√©rez', email: 'maria.p@example.com', phone: '+34123456789', message: 'Hola, estoy interesada en Plantilla LemusPool. ¬øPodemos agendar llamada?', date: new Date().toISOString(), handled: false, archived: false, template: 'Plantilla LemusPool' }, { id: Date.now()+2, name: 'Juan Gonz√°lez', email: 'juan.g@example.com', phone: '+34987654321', message: 'Necesito informaci√≥n sobre precios y soporte.', date: new Date(Date.now()-3600*1000).toISOString(), handled: false, archived: false, template: 'Plantilla Arzopa Aqua' }, { id: Date.now()+3, name: 'Carlos D√≠az', email: 'carlos.d@example.com', phone: '+34111222333', message: '¬øLa plantilla Minimalista incluye secci√≥n de galer√≠a?', date: new Date(Date.now()-7200*1000).toISOString(), handled: false, archived: false, template: 'Plantilla Minimalista' } ]; saveResetRequests(samples); renderResetRequests(); setTimeout(() => { const first = document.querySelector('#page-solicitudes .inbox-list .inbox-item'); if (first) first.click(); }, 150); } catch (e) { console.error('restoreSampleResetRequests', e); } }

    function openAdminResetModal(requestId) { const list = getResetRequests(); const req = list.find(r => r.id === requestId); if (!req) return alert('Solicitud no encontrada'); document.getElementById('adminResetRequestId').value = req.id; document.getElementById('adminResetEmail').value = req.email; document.getElementById('adminNewPassword').value = ''; document.getElementById('adminNewPasswordConfirm').value = ''; const msg = document.getElementById('adminResetMessage'); msg.classList.add('d-none'); msg.textContent = ''; const modalEl = document.getElementById('adminResetModal'); const modal = new bootstrap.Modal(modalEl, { backdrop: false }); modal.show(); }
    function saveAdminResetPassword() { const id = Number(document.getElementById('adminResetRequestId').value); const email = document.getElementById('adminResetEmail').value; const p1 = document.getElementById('adminNewPassword').value; const p2 = document.getElementById('adminNewPasswordConfirm').value; const msg = document.getElementById('adminResetMessage'); if (!p1 || !p2) { msg.className = 'alert alert-danger'; msg.textContent = 'Completa ambos campos de contrase√±a.'; return; } if (p1 !== p2) { msg.className = 'alert alert-danger'; msg.textContent = 'Las contrase√±as no coinciden.'; return; } try { const raw = localStorage.getItem('users'); const users = raw ? JSON.parse(raw) : {}; users[email] = { password: p1, updatedAt: new Date().toISOString() }; localStorage.setItem('users', JSON.stringify(users)); markRequestHandled(id, false); msg.className = 'alert alert-success'; msg.textContent = 'Contrase√±a restablecida correctamente.'; setTimeout(() => { const modalEl = document.getElementById('adminResetModal'); const modal = bootstrap.Modal.getInstance(modalEl); if (modal) modal.hide(); renderResetRequests(); }, 1000); } catch (e) { console.error(e); msg.className = 'alert alert-danger'; msg.textContent = 'Error guardando la contrase√±a.'; } }
    function markRequestHandled(id, rerender=true) {
        try {
            if (!id) return;
            // animate icon immediately
            try { updateInboxIcon(id, true); } catch(e){}
            const list = getResetRequests();
            const idx = list.findIndex(r => String(r.id) === String(id));
            if (idx !== -1) {
                // if we want to show animation before re-render, delay the save+render
                if (rerender) {
                    setTimeout(() => {
                        list[idx].handled = true;
                        list[idx].handledAt = new Date().toISOString();
                        saveResetRequests(list);
                        renderResetRequests();
                    }, 300);
                } else {
                    list[idx].handled = true;
                    list[idx].handledAt = new Date().toISOString();
                    saveResetRequests(list);
                }
            } else {
                if (rerender) renderResetRequests();
            }
        } catch (e) { console.error(e); }
    }

    // --- Plantillas ---
    function getTemplates() { try { const raw = localStorage.getItem('templates'); return raw ? JSON.parse(raw) : null; } catch (e) { console.error(e); return null; } }
    function saveTemplates(data) { try { localStorage.setItem('templates', JSON.stringify(data)); } catch (e) { console.error(e); } }
    function initTemplatesFromDOM() { let templates = getTemplates(); if (templates) return; templates = {}; document.querySelectorAll('.template-card[data-template-id]').forEach(card => { const id = card.getAttribute('data-template-id'); const img = card.querySelector('img'); const title = card.querySelector('.template-content h4')?.textContent || ''; const desc = card.querySelector('.template-content p')?.textContent || ''; templates[id] = { id: id, name: title, description: desc, image: img ? img.getAttribute('src') : '', demos: { login: '', main: '', admin: '' } }; }); saveTemplates(templates); }
    function openTemplateEditModal(templateId) { const templates = getTemplates() || {}; const tpl = templates[templateId] || null; if (!tpl) return alert('Plantilla no encontrada'); document.getElementById('templateEditId').value = tpl.id; document.getElementById('templateEditName').value = tpl.name || ''; document.getElementById('templateEditDesc').value = tpl.description || ''; document.getElementById('templateEditDemoLogin').value = (tpl.demos && tpl.demos.login) ? tpl.demos.login : ''; document.getElementById('templateEditDemoMain').value = (tpl.demos && tpl.demos.main) ? tpl.demos.main : ''; document.getElementById('templateEditDemoAdmin').value = (tpl.demos && tpl.demos.admin) ? tpl.demos.admin : ''; const preview = document.getElementById('templateEditImagePreview'); if (tpl.image) { preview.src = tpl.image; preview.style.display = 'block'; } else { preview.src = ''; preview.style.display = 'none'; } document.getElementById('templateEditImage').value = ''; const modalEl = document.getElementById('templateEditModal'); const modal = new bootstrap.Modal(modalEl, { backdrop: true }); modal.show(); }
    function handleImagePreview(fileInput) { const file = fileInput.files && fileInput.files[0]; const preview = document.getElementById('templateEditImagePreview'); if (!file) { preview.src = ''; preview.style.display = 'none'; return; } const reader = new FileReader(); reader.onload = function(e) { preview.src = e.target.result; preview.style.display = 'block'; }; reader.readAsDataURL(file); }
    function saveTemplateEdit() { try { const id = document.getElementById('templateEditId').value; const name = document.getElementById('templateEditName').value.trim(); const desc = document.getElementById('templateEditDesc').value.trim(); const demoLogin = document.getElementById('templateEditDemoLogin').value.trim(); const demoMain = document.getElementById('templateEditDemoMain').value.trim(); const demoAdmin = document.getElementById('templateEditDemoAdmin').value.trim(); const fileInput = document.getElementById('templateEditImage'); const templates = getTemplates() || {}; if (!templates[id]) templates[id] = { id, name: '', description: '', image: '', demos: {} }; const tpl = templates[id]; tpl.name = name; tpl.description = desc; tpl.demos = { login: demoLogin, main: demoMain, admin: demoAdmin }; templates[id] = tpl; saveTemplates(templates); const card = document.querySelector('.template-card[data-template-id="' + id + '"]'); if (card) { const img = card.querySelector('img'); if (img && tpl.image) img.src = tpl.image; const title = card.querySelector('.template-content h4'); if (title) title.textContent = tpl.name; const p = card.querySelector('.template-content p'); if (p) p.textContent = tpl.description; } const msgEl = document.getElementById('templateEditMessage'); msgEl.className = 'alert alert-info'; msgEl.textContent = 'Guardando en servidor...'; const fd = new FormData(); fd.append('id', id); fd.append('name', name); fd.append('description', desc); fd.append('demoLogin', demoLogin); fd.append('demoMain', demoMain); fd.append('demoAdmin', demoAdmin); if (fileInput && fileInput.files && fileInput.files[0]) fd.append('image', fileInput.files[0]); fetch('/vendedor/php/save_templates.php', { method: 'POST', body: fd }).then(r => r.json()).then(res => { if (res && res.success) { const templatesSrv = getTemplates() || {}; templatesSrv[id] = templatesSrv[id] || {}; templatesSrv[id].id = id; templatesSrv[id].name = res.template.name || name; templatesSrv[id].description = res.template.description || desc; templatesSrv[id].demos = res.template.demos || { login: demoLogin, main: demoMain, admin: demoAdmin }; if (res.template.image) templatesSrv[id].image = res.template.image; saveTemplates(templatesSrv); if (card && res.template.image) { const img = card.querySelector('img'); if (img) img.src = res.template.image; } msgEl.className = 'alert alert-success'; msgEl.textContent = 'Plantilla guardada en servidor.'; setTimeout(() => { const modalEl = document.getElementById('templateEditModal'); const modal = bootstrap.Modal.getInstance(modalEl); if (modal) modal.hide(); renderResetRequests(); }, 700); } else { msgEl.className = 'alert alert-warning'; msgEl.textContent = (res && res.message) ? res.message : 'Guardado local, pero error en servidor.'; } }).catch(err => { console.error('Error enviando a servidor', err); msgEl.className = 'alert alert-danger'; msgEl.textContent = 'Error al guardar en servidor. Cambios locales aplicados.'; setTimeout(() => { const modalEl = document.getElementById('templateEditModal'); const modal = bootstrap.Modal.getInstance(modalEl); if (modal) modal.hide(); }, 1200); }); } catch (e) { console.error(e); const msg = document.getElementById('templateEditMessage'); msg.className = 'alert alert-danger'; msg.textContent = 'Error al guardar la plantilla.'; } }
    function fetchTemplatesFromServer(){ return fetch('/vendedor/php/get_templates.php').then(r => r.json()).then(list => { if (!Array.isArray(list)) return Promise.reject('Respuesta inv√°lida'); const out = {}; list.forEach(t => { if (t && t.id) out[t.id] = t; }); saveTemplates(out); Object.keys(out).forEach(id => { const card = document.querySelector('.template-card[data-template-id="' + id + '"]'); const tpl = out[id]; if (card) { const img = card.querySelector('img'); if (img && tpl.image) img.src = tpl.image; const title = card.querySelector('.template-content h4'); if (title) title.textContent = tpl.name || title.textContent; const p = card.querySelector('.template-content p'); if (p) p.textContent = tpl.description || p.textContent; } }); }); }
    function attachTemplateEditListeners() { document.querySelectorAll('.btn-edit-template').forEach(btn => { if (btn.__editAttached) return; btn.__editAttached = true; btn.addEventListener('click', function(e) { const card = e.target.closest('.template-card'); if (!card) return; const id = card.getAttribute('data-template-id'); if (!id) return alert('Plantilla sin id'); openTemplateEditModal(id); }); }); const imgInput = document.getElementById('templateEditImage'); if (imgInput) { imgInput.addEventListener('change', function() { handleImagePreview(this); }); } const saveBtn = document.getElementById('templateEditSaveButton'); if (saveBtn) { saveBtn.addEventListener('click', saveTemplateEdit); } }

    document.addEventListener('DOMContentLoaded', () => { try { renderResetRequests(); const btn = document.getElementById('adminSavePasswordButton'); if (btn) btn.addEventListener('click', saveAdminResetPassword); fetchTemplatesFromServer().then(() => { attachTemplateEditListeners(); }).catch((err) => { console.warn('No se pudo cargar plantillas desde servidor, usando DOM local.', err); initTemplatesFromDOM(); attachTemplateEditListeners(); }); } catch (e) { console.error(e); } });

    // === Editor p√∫blico de plantillas (UI parecido al modal de plantilla) ===
    function openPublicTemplateEditor(){
        // build select from existing template cards
        const select = document.getElementById('publicTemplateSelect'); if (!select) return;
        select.innerHTML = '';
        const cards = document.querySelectorAll('.template-card[data-template-id]');
        const templates = getTemplates() || {};
        cards.forEach(card => {
            const id = card.getAttribute('data-template-id');
            const title = (templates && templates[id] && templates[id].name) ? templates[id].name : (card.querySelector('.template-content h4') ? card.querySelector('.template-content h4').textContent.trim() : id);
            const opt = document.createElement('option'); opt.value = id; opt.textContent = title; select.appendChild(opt);
        });
        // load first
        loadPublicTemplateIntoForm(select.value);
        // open modal
        const modalEl = document.getElementById('publicTemplateEditModal'); const modal = new bootstrap.Modal(modalEl, { backdrop: true }); modal.show();
    }

    function loadPublicTemplateIntoForm(templateId){
        const templates = getTemplates() || {};
        const tpl = templates[templateId] || null;
        const name = tpl ? tpl.name || '' : '';
        const desc = tpl ? tpl.description || '' : '';
        const img = tpl ? tpl.image || '' : '';
        const demos = (tpl && tpl.demos) ? tpl.demos : { login:'', main:'', admin:'' };
        document.getElementById('publicTplName').value = name;
        document.getElementById('publicTplDesc').value = desc;
        const preview = document.getElementById('publicTplImagePreview'); if (preview) { if (img) { preview.src = img; preview.style.display = 'block'; } else { preview.src = ''; preview.style.display = 'none'; } }
        document.getElementById('publicTplDemoLogin').value = demos.login || '';
        document.getElementById('publicTplDemoMain').value = demos.main || '';
        document.getElementById('publicTplDemoAdmin').value = demos.admin || '';
        // store selected id on modal element
        const modalEl = document.getElementById('publicTemplateEditModal'); if (modalEl) modalEl.dataset.selectedTemplate = templateId;
    }

    // handle select change
    document.addEventListener('DOMContentLoaded', function(){ const select = document.getElementById('publicTemplateSelect'); if (select) select.addEventListener('change', function(){ loadPublicTemplateIntoForm(this.value); });
        const fileInput = document.getElementById('publicTplImage'); if (fileInput) fileInput.addEventListener('change', function(){ const f = this.files && this.files[0]; const preview = document.getElementById('publicTplImagePreview'); if (!f){ if(preview){ preview.src=''; preview.style.display='none'; } return; } const reader = new FileReader(); reader.onload = function(e){ if(preview){ preview.src = e.target.result; preview.style.display='block'; } }; reader.readAsDataURL(f); });
        const saveBtn = document.getElementById('publicTplSaveButton'); if (saveBtn) saveBtn.addEventListener('click', function(){ try { const modalEl = document.getElementById('publicTemplateEditModal'); const tid = modalEl && modalEl.dataset && modalEl.dataset.selectedTemplate ? modalEl.dataset.selectedTemplate : document.getElementById('publicTemplateSelect').value; if (!tid) return alert('Selecciona una plantilla.'); const templates = getTemplates() || {}; const tpl = templates[tid] || { id: tid, name:'', description:'', image:'', demos:{} }; tpl.name = document.getElementById('publicTplName').value.trim(); tpl.description = document.getElementById('publicTplDesc').value.trim(); tpl.demos = { login: document.getElementById('publicTplDemoLogin').value.trim(), main: document.getElementById('publicTplDemoMain').value.trim(), admin: document.getElementById('publicTplDemoAdmin').value.trim() };
                    const fileInput2 = document.getElementById('publicTplImage'); if (fileInput2 && fileInput2.files && fileInput2.files[0]){
                        const reader2 = new FileReader(); reader2.onload = function(e){ tpl.image = e.target.result; templates[tid] = tpl; saveTemplates(templates); // update DOM
                                const card = document.querySelector('.template-card[data-template-id="'+tid+'"]'); if (card){ const img = card.querySelector('img'); if (img) img.src = tpl.image; const title = card.querySelector('.template-content h4'); if (title) title.textContent = tpl.name; const p = card.querySelector('.template-content p'); if (p) p.textContent = tpl.description; }
                                const msgEl = document.getElementById('publicTplMessage'); if (msgEl){ msgEl.className='alert alert-success'; msgEl.textContent='Plantilla actualizada.'; setTimeout(()=>{ const modal = bootstrap.Modal.getInstance(modalEl); if(modal) modal.hide(); msgEl.classList.add('d-none'); },700); }
                        }; reader2.readAsDataURL(fileInput2.files[0]);
                    } else { templates[tid] = tpl; saveTemplates(templates); const card = document.querySelector('.template-card[data-template-id="'+tid+'"]'); if (card){ const title = card.querySelector('.template-content h4'); if (title) title.textContent = tpl.name; const p = card.querySelector('.template-content p'); if (p) p.textContent = tpl.description; const img = card.querySelector('img'); if (img && tpl.image) img.src = tpl.image; }
                        const msgEl = document.getElementById('publicTplMessage'); if (msgEl){ msgEl.className='alert alert-success'; msgEl.textContent='Plantilla actualizada.'; setTimeout(()=>{ const modal = bootstrap.Modal.getInstance(modalEl); if(modal) modal.hide(); msgEl.classList.add('d-none'); },700); }
                    }
                    // trigger update on public page via localStorage templates key
                    try { window.dispatchEvent(new Event('storage')); } catch(e){}
                } catch(e){ console.error(e); alert('Error guardando plantilla p√∫blica'); } }); });

    // === Clientes: detalle y edici√≥n r√°pida ===
    function getClientsData(){ try { const raw = localStorage.getItem('clients_data'); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }
    function saveClientsData(data){ try { localStorage.setItem('clients_data', JSON.stringify(data)); } catch(e){} }
        // parse a currency string like "$1,200" or "1,200.50" into a Number (returns 0 if invalid)
        function parseCurrency(str){ try { if (str === null || str === undefined) return 0; var s = String(str).trim(); if (s === '') return 0; // remove $ and non numeric characters except dot and minus
            s = s.replace(/\$/g,'').replace(/,/g,'').replace(/\s+/g,''); s = s.replace(/[^0-9.\-]/g,''); var n = parseFloat(s); return isNaN(n) ? 0 : n; } catch(e){ return 0; } }
        // format number to currency string (e.g. 1200 -> "$1,200.00")
        function formatCurrency(num){ try { var n = Number(num); if (isNaN(n)) n = 0; return '$' + n.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).replace(/\.00$/, ''); } catch(e){ return '$0'; } }
    function initClientsFromDOM(){
        let list = getClientsData();
        if (!list) { list = []; document.querySelectorAll('#page-clientes table tbody tr').forEach(tr => {
            const id = tr.dataset.clientId || ('row_' + list.length);
            const name = tr.dataset.name || tr.children[0].textContent.trim();
            const status = tr.dataset.status || (tr.querySelector('td:nth-child(2)') ? tr.querySelector('td:nth-child(2)').textContent.trim() : '');
            const template = tr.dataset.template || (tr.children[2] ? tr.children[2].textContent.trim() : '');
            const payment = tr.dataset.paymentMethod || tr.dataset.payment || '';
            const amountRaw = tr.dataset.amount || (tr.children[4] ? tr.children[4].textContent.trim() : '') || '0';
            const amount = parseCurrency(amountRaw);
            const next = tr.dataset.nextPayment || (tr.children[5] ? tr.children[5].textContent.trim() : '');
            list.push({ id, name, status, template, paymentMethod: payment, amountPaid: amount, nextPayment: next });
        }); saveClientsData(list); }
        return list;
    }

    function openClientDetailFromRow(tr){
        const modalEl = document.getElementById('clientDetailModal');
        const modal = new bootstrap.Modal(modalEl, { backdrop: true });
        const id = tr.dataset.clientId || '';
        const name = tr.dataset.name || tr.children[0].textContent.trim();
        const status = tr.dataset.status || (tr.querySelector('td:nth-child(2)') ? tr.querySelector('td:nth-child(2)').textContent.trim() : '');
        const template = tr.dataset.template || (tr.children[2] ? tr.children[2].textContent.trim() : '');
        const payment = tr.dataset.paymentMethod || tr.dataset.payment || '';
        const amountRaw = tr.dataset.amount || (tr.children[4] ? tr.children[4].textContent.trim() : '') || '0';
        const amount = parseCurrency(amountRaw);
        const next = tr.dataset.nextPayment || (tr.children[5] ? tr.children[5].textContent.trim() : '');
        document.getElementById('clientDetailId').value = id;
        document.getElementById('clientDetailName').value = name;
        document.getElementById('clientDetailTemplate').value = template;
        document.getElementById('clientDetailPaymentMethod').value = payment;
        document.getElementById('clientDetailAmount').value = (amount || amount === 0) ? ('' + amount) : '';
        document.getElementById('clientDetailNextPayment').value = next;
        document.getElementById('clientDetailStatus').value = status;
        modal.show();
    }

    function bindClientDetailButtons(){
        document.querySelectorAll('.btn-view-client').forEach(btn => {
            if (btn.__clientAttached) return; btn.__clientAttached = true;
            btn.addEventListener('click', function(e){
                const tr = this.closest('tr'); if (!tr) return;
                openClientDetailFromRow(tr);
            });
        });
    }

    function applyClientChangesToRow(id, changes){
        // find row by data-client-id
        const tr = document.querySelector('#page-clientes table tbody tr[data-client-id="' + id + '"]');
        if (!tr) return;
        if (changes.template !== undefined) { tr.children[2].textContent = changes.template; tr.dataset.template = changes.template; }
        if (changes.amountPaid !== undefined) { 
            var num = parseCurrency(changes.amountPaid);
            tr.children[4].textContent = formatCurrency(num);
            tr.dataset.amount = String(num);
        }
        if (changes.nextPayment !== undefined) { tr.children[5].textContent = changes.nextPayment; tr.dataset.nextPayment = changes.nextPayment; }
        if (changes.paymentMethod !== undefined) { tr.dataset.paymentMethod = changes.paymentMethod; }
        if (changes.status !== undefined) {
            tr.dataset.status = changes.status;
            const span = tr.querySelector('td:nth-child(2) span'); if (span) {
                span.textContent = changes.status;
                span.className = 'status ' + (changes.status === 'Activo' ? 'status-active' : (changes.status === 'Atrasado' ? 'status-late' : (changes.status === 'Pendiente' ? 'status-pending' : (changes.status === 'Cancelado' ? 'status-canceled' : ''))));
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function(){
        try { initClientsFromDOM(); bindClientDetailButtons(); } catch(e) { console.error('clients init', e); }
        const saveBtn = document.getElementById('clientDetailSave'); if (saveBtn) saveBtn.addEventListener('click', function(){
            const id = document.getElementById('clientDetailId').value;
            const template = document.getElementById('clientDetailTemplate').value.trim();
            const paymentMethod = document.getElementById('clientDetailPaymentMethod').value.trim();
            const amountPaidRaw = document.getElementById('clientDetailAmount') ? document.getElementById('clientDetailAmount').value.trim() : '';
            const amountPaid = parseCurrency(amountPaidRaw);
            const nextPayment = document.getElementById('clientDetailNextPayment').value.trim();
            const status = document.getElementById('clientDetailStatus').value;
            // persist in localStorage
            try {
                const clients = getClientsData() || [];
                const idx = clients.findIndex(c => c.id === id || c.name === document.getElementById('clientDetailName').value);
                if (idx !== -1) { clients[idx].template = template; clients[idx].paymentMethod = paymentMethod; clients[idx].amountPaid = amountPaid; clients[idx].nextPayment = nextPayment; clients[idx].status = status; }
                else { clients.push({ id: id || ('c_' + Date.now()), name: document.getElementById('clientDetailName').value, template, paymentMethod, amountPaid, nextPayment, status }); }
                saveClientsData(clients);
            } catch(e) { console.error('save client local', e); }
            applyClientChangesToRow(id, { template, paymentMethod, amountPaid: amountPaid, nextPayment, status });
            const modalEl = document.getElementById('clientDetailModal'); const modal = bootstrap.Modal.getInstance(modalEl); if (modal) modal.hide();
        });
    });

    // --- Configuraci√≥n IIFE ---
    (function(){
        const KEY = 'admin_config';
        function loadConfig(){ try { const raw = localStorage.getItem(KEY); const cfg = raw ? JSON.parse(raw) : {}; if (document.getElementById('cfgAdminEmail')) document.getElementById('cfgAdminEmail').value = cfg.adminEmail || ''; if (document.getElementById('siteTitle')) document.getElementById('siteTitle').value = cfg.siteTitle || ''; if (document.getElementById('defaultTemplate')) document.getElementById('defaultTemplate').value = cfg.defaultTemplate || ''; if (document.getElementById('notifyNewRequests')) document.getElementById('notifyNewRequests').checked = !!cfg.notifyNewRequests; if (document.getElementById('notifyLowBalance')) document.getElementById('notifyLowBalance').checked = !!cfg.notifyLowBalance; if (document.getElementById('smtpHost')) document.getElementById('smtpHost').value = cfg.smtpHost || ''; if (document.getElementById('smtpPort')) document.getElementById('smtpPort').value = cfg.smtpPort || ''; if (document.getElementById('smtpUser')) document.getElementById('smtpUser').value = cfg.smtpUser || ''; if (document.getElementById('smtpPass')) document.getElementById('smtpPass').value = cfg.smtpPass || ''; } catch (e) { console.error('loadConfig', e); } }
        function readConfig(){ try { const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : {}; } catch (e) { return {}; } }
        function showMessage(elId, text, type='success'){ const el = document.getElementById(elId); if (!el) return; el.className = 'alert alert-' + (type === 'success' ? 'success' : 'danger'); el.textContent = text; el.classList.remove('d-none'); setTimeout(() => { try { el.classList.add('d-none'); } catch(e){} }, 3000); }
        function applySavedSections(){ document.querySelectorAll('.config-card[data-section-id]').forEach(card => { const id = card.getAttribute('data-section-id'); const key = 'admin_section_' + id; const raw = localStorage.getItem(key); if (raw) { const form = card.querySelector('form'); if (form) form.innerHTML = raw; } }); }
        function bindConfigButtons(){ const saveAccount = document.getElementById('saveAccountConfig'); if (saveAccount) saveAccount.onclick = function(){ const cfg = readConfig(); const emailEl = document.getElementById('cfgAdminEmail'); const newP = document.getElementById('cfgNewPassword') ? document.getElementById('cfgNewPassword').value : ''; const conf = document.getElementById('cfgNewPasswordConfirm') ? document.getElementById('cfgNewPasswordConfirm').value : ''; if ((newP || conf) && newP !== conf){ showMessage('accountConfigMessage','Las contrase√±as no coinciden','error'); return; } if (newP) cfg.adminPassword = newP; if (emailEl) cfg.adminEmail = emailEl.value.trim(); localStorage.setItem(KEY, JSON.stringify(cfg)); showMessage('accountConfigMessage','Configuraci√≥n de cuenta guardada','success'); };
            const saveSite = document.getElementById('saveSiteSettings'); if (saveSite) saveSite.onclick = function(){ const cfg = readConfig(); const titleEl = document.getElementById('siteTitle'); const defTpl = document.getElementById('defaultTemplate'); if (titleEl) cfg.siteTitle = titleEl.value.trim(); if (defTpl) cfg.defaultTemplate = defTpl.value; localStorage.setItem(KEY, JSON.stringify(cfg)); showMessage('siteSettingsMessage','Ajustes del sitio guardados','success'); };
            const saveNotif = document.getElementById('saveNotifications'); if (saveNotif) saveNotif.onclick = function(){ const cfg = readConfig(); const n1 = document.getElementById('notifyNewRequests'); const n2 = document.getElementById('notifyLowBalance'); cfg.notifyNewRequests = !!(n1 && n1.checked); cfg.notifyLowBalance = !!(n2 && n2.checked); localStorage.setItem(KEY, JSON.stringify(cfg)); showMessage('notificationsMessage','Preferencias de notificaci√≥n guardadas','success'); };
            const saveSmtp = document.getElementById('saveSmtpConfig'); if (saveSmtp) saveSmtp.onclick = function(){ const cfg = readConfig(); const host = document.getElementById('smtpHost'); const port = document.getElementById('smtpPort'); const user = document.getElementById('smtpUser'); const pass = document.getElementById('smtpPass'); cfg.smtpHost = host ? host.value.trim() : ''; cfg.smtpPort = port ? port.value.trim() : ''; cfg.smtpUser = user ? user.value.trim() : ''; cfg.smtpPass = pass ? pass.value : ''; localStorage.setItem(KEY, JSON.stringify(cfg)); showMessage('smtpMessage','Configuraci√≥n SMTP guardada localmente','success'); };
        }
        function openSectionEditor(sectionId){ const card = document.querySelector('.config-card[data-section-id="' + sectionId + '"]'); if (!card) return alert('Secci√≥n no encontrada'); const form = card.querySelector('form'); const textarea = document.getElementById('sectionEditContent'); textarea.value = form ? form.innerHTML : ''; document.getElementById('sectionEditId').value = sectionId; // clear public dataset
            const modalEl = document.getElementById('sectionEditModal'); delete modalEl.dataset.publicSection; delete modalEl.dataset.targetSelector; delete modalEl.dataset.attrName; const modal = new bootstrap.Modal(modalEl, { backdrop: true }); modal.show(); }

        // Abrir editor para componentes p√∫blicos (pagina_principal.html)
        function openPublicEditor(sectionId, selector, title, attrName){
            const textarea = document.getElementById('sectionEditContent');
            const key = 'public_section_' + sectionId;
            const existing = localStorage.getItem(key) || '';
            // Si el valor es JSON y representa un atributo, mostrar modo atributo
            let isAttr = false;
            try {
                const parsed = existing ? JSON.parse(existing) : null;
                if (parsed && parsed.__attr) { isAttr = true; }
            } catch(e) { /* no JSON */ }

            document.getElementById('sectionEditId').value = sectionId;
            const modalEl2 = document.getElementById('sectionEditModal');
            modalEl2.querySelector('.modal-title').textContent = 'Editar: ' + (title || sectionId);
            modalEl2.dataset.publicSection = '1';
            modalEl2.dataset.targetSelector = selector;
            modalEl2.dataset.publicLabel = title || sectionId;
            if (attrName) modalEl2.dataset.attrName = attrName; else delete modalEl2.dataset.attrName;

            // preparar campos
            const selectorDisplay = modalEl2.querySelector('#sectionEditSelector'); if (selectorDisplay) selectorDisplay.textContent = selector || '';
            const modeContent = document.getElementById('modeContent'); const modeAttr = document.getElementById('modeAttr');
            const contentArea = document.getElementById('contentEditorArea'); const attrArea = document.getElementById('attrEditorArea');
            const attrNameInput = document.getElementById('sectionEditAttrName'); const attrValueInput = document.getElementById('sectionEditAttrValue');

            if (isAttr) {
                try {
                    const parsed = JSON.parse(existing);
                    modeAttr.checked = true; modeContent.checked = false; contentArea.classList.add('d-none'); attrArea.classList.remove('d-none');
                    attrNameInput.value = parsed.attr || (modalEl2.dataset.attrName || 'src');
                    attrValueInput.value = parsed.value || '';
                    textarea.value = '';
                } catch(e){ textarea.value = existing || ''; }
            } else {
                modeContent.checked = true; modeAttr.checked = false; contentArea.classList.remove('d-none'); attrArea.classList.add('d-none');
                // si existe attrName but not JSON, prefill attrName
                attrNameInput.value = modalEl2.dataset.attrName || '';
                textarea.value = existing || '';
                attrValueInput.value = '';
            }

            // mostrar modal
            const modal2 = new bootstrap.Modal(modalEl2, { backdrop: true }); modal2.show();
        }

        function saveSectionEditor(){
            const sectionId = document.getElementById('sectionEditId').value;
            const content = document.getElementById('sectionEditContent').value;
            const modalEl = document.getElementById('sectionEditModal');
            try {
                if (modalEl && modalEl.dataset && modalEl.dataset.publicSection === '1') {
                    // edici√≥n p√∫blica: puede ser contenido o atributo
                    const modeAttrChecked = document.getElementById('modeAttr').checked;
                    const sel = modalEl.dataset.targetSelector;
                    if (modeAttrChecked) {
                        const attrName = document.getElementById('sectionEditAttrName').value.trim();
                        const attrValue = document.getElementById('sectionEditAttrValue').value.trim();
                        if (!attrName) return alert('Especifica un nombre de atributo (ej: src, href, alt)');
                        const payload = { __attr: true, attr: attrName, value: attrValue };
                        localStorage.setItem('public_section_' + sectionId, JSON.stringify(payload));
                        // aplicar instant√°neamente en el admin preview si hay selector
                        if (sel) {
                            try { document.querySelectorAll(sel).forEach(n => { n.setAttribute(attrName, attrValue); }); } catch(e) { }
                        }
                    } else {
                        // contenido HTML
                        localStorage.setItem('public_section_' + sectionId, content);
                        if (sel) {
                            try { document.querySelectorAll(sel).forEach(n => { n.innerHTML = content; }); } catch(e) { }
                        }
                    }
                    // dispatch storage event for other tabs
                    try { window.dispatchEvent(new Event('storage')); } catch(e){}
                } else {
                    // guardar como admin_section habitual
                    const key = 'admin_section_' + sectionId; localStorage.setItem(key, content); const card = document.querySelector('.config-card[data-section-id="' + sectionId + '"]'); if (card) { const form = card.querySelector('form'); if (form) form.innerHTML = content; } bindConfigButtons(); loadConfig();
                }
                const modal = bootstrap.Modal.getInstance(modalEl); if (modal) modal.hide();
            } catch (e) { console.error(e); alert('Error guardando la secci√≥n'); }
        }

        function bindSectionEditButtons(){ document.querySelectorAll('.edit-section-btn').forEach(btn => { if (btn.__secAttached) return; btn.__secAttached = true; btn.addEventListener('click', function(e){ const card = e.target.closest('.config-card'); if (!card) return; const id = card.getAttribute('data-section-id'); openSectionEditor(id); }); }); }

        // Botones que editan componentes p√∫blicos (mapeados con data-section, data-selector, opcional data-attr)
        function bindPublicEditButtons(){
            document.querySelectorAll('.edit-public-btn').forEach(btn => {
                if (btn.__pubAttached) return; btn.__pubAttached = true;
                btn.addEventListener('click', function(e){
                    e.preventDefault();
                    const sec = this.getAttribute('data-section');
                    const sel = this.getAttribute('data-selector');
                    const label = this.textContent || sec;
                    const attr = this.getAttribute('data-attr') || null;
                    // Si se trata de plantillas, abrir editor de plantillas p√∫blico
                    if (sec && (sec.indexOf('plantill') !== -1 || sec.indexOf('plantillas') !== -1 || sec.startsWith('plantillas') || sec.startsWith('plantilla'))) {
                        openPublicTemplateEditor();
                        return;
                    }
                    openPublicEditor(sec, sel, label, attr);
                });
            });
        }

        // Botones para edici√≥n estructurada (features, plans, contact form fields)
        function bindStructuredEditButtons(){
            document.querySelectorAll('.edit-structured-btn').forEach(btn => {
                if (btn.__structAttached) return; btn.__structAttached = true;
                btn.addEventListener('click', function(e){
                    e.preventDefault();
                    const sec = this.getAttribute('data-section');
                    const sel = this.getAttribute('data-selector');
                    openStructuredEditor(sec, sel);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function(){ applySavedSections(); loadConfig(); bindConfigButtons(); bindSectionEditButtons(); bindPublicEditButtons(); });
        // bind structured buttons after public ones
        document.addEventListener('DOMContentLoaded', function(){ bindStructuredEditButtons(); });
        window.__adminConfig = { loadConfig, bindConfigButtons, applySavedSections };
    })();

    // Bind sectionEditSave
    document.addEventListener('DOMContentLoaded', function(){ const saveBtn = document.getElementById('sectionEditSave'); if (saveBtn) saveBtn.addEventListener('click', saveSectionEditor); });

    // Toggle editor mode (contenido vs atributo) dentro del modal
    document.addEventListener('DOMContentLoaded', function(){
        const modeContent = document.getElementById('modeContent');
        const modeAttr = document.getElementById('modeAttr');
        const contentArea = document.getElementById('contentEditorArea');
        const attrArea = document.getElementById('attrEditorArea');
        const selectorDisplay = document.getElementById('sectionEditSelector');
        function updateMode(){ if (modeAttr && modeAttr.checked) { contentArea.classList.add('d-none'); attrArea.classList.remove('d-none'); } else { contentArea.classList.remove('d-none'); attrArea.classList.add('d-none'); } }
        if (modeContent) modeContent.addEventListener('change', updateMode);
        if (modeAttr) modeAttr.addEventListener('change', updateMode);
        // cuando se abra el modal, actualizar el selector mostrado
        const modalEl = document.getElementById('sectionEditModal');
        if (modalEl) {
            modalEl.addEventListener('show.bs.modal', function(e){
                const sel = modalEl.dataset.targetSelector || '';
                if (selectorDisplay) selectorDisplay.textContent = sel;
                updateMode();
                // Focus appropriate field depending on mode
                setTimeout(() => {
                    try {
                        if (modeAttr && modeAttr.checked) {
                            const attrInput = document.getElementById('sectionEditAttrValue'); if (attrInput) attrInput.focus();
                        } else {
                            const ta = document.getElementById('sectionEditContent'); if (ta) { ta.focus(); ta.selectionStart = ta.value.length; }
                        }
                    } catch(e){}
                }, 80);
            });
        }
        
        // ==== Edici√≥n Estructurada: abrir modal con campos generados ==== 
        function openStructuredEditor(sectionId, selector){
            // supported sectionId: features_struct, plans_struct, contact_form_struct
            const modalEl = document.getElementById('sectionEditModal');
            const title = (sectionId === 'features_struct') ? 'Editar Features (estructurado)' : (sectionId === 'plans_struct' ? 'Editar Plans (estructurado)' : (sectionId === 'contact_form_struct' ? 'Editar Formulario (campos)' : 'Editar'));
            modalEl.querySelector('.modal-title').textContent = title;
            modalEl.dataset.publicSection = '1';
            modalEl.dataset.targetSelector = selector;
            document.getElementById('sectionEditId').value = sectionId;

            const contentArea = document.getElementById('contentEditorArea');
            const attrArea = document.getElementById('attrEditorArea');
            // Clear standard inputs
            document.getElementById('sectionEditContent').value = '';
            document.getElementById('sectionEditAttrName').value = '';
            document.getElementById('sectionEditAttrValue').value = '';

            // build structured form inside contentEditorArea
            let html = '';
            const existingRaw = localStorage.getItem('public_section_' + sectionId) || '';
            let existing = null;
            try { existing = existingRaw ? JSON.parse(existingRaw) : null; } catch(e) { existing = null; }

            if (sectionId === 'features_struct'){
                // features: array of cards with title and bullets
                const cards = document.querySelectorAll('.features .feature-card');
                html += '<div class="structured-form">';
                cards.forEach((card, i) => {
                    const t = (existing && existing.items && existing.items[i] && existing.items[i].title) ? existing.items[i].title : (card.querySelector('h3') ? card.querySelector('h3').textContent.trim() : '');
                    const listEls = card.querySelectorAll('.feature-list li');
                    const bullets = (existing && existing.items && existing.items[i] && existing.items[i].bullets) ? existing.items[i].bullets.join('\n') : Array.from(listEls).map(li => li.textContent.trim()).join('\n');
                    html += `<div class="mb-3"><label class="form-label">Card ${i+1} - T√≠tulo</label><input class="form-control struct-title" data-index="${i}" value="${escapeHtmlAttr(t)}"></div>`;
                    html += `<div class="mb-3"><label class="form-label">Card ${i+1} - Bullets (una por l√≠nea)</label><textarea class="form-control struct-bullets" data-index="${i}">${escapeHtmlAttr(bullets)}</textarea></div>`;
                });
                html += '</div>';
            } else if (sectionId === 'plans_struct'){
                const plans = document.querySelectorAll('.plans-grid .plan-card');
                html += '<div class="structured-form">';
                plans.forEach((plan, i) => {
                    const title = (existing && existing.items && existing.items[i] && existing.items[i].title) ? existing.items[i].title : (plan.querySelector('h3') ? plan.querySelector('h3').textContent.trim() : '');
                    const price = (existing && existing.items && existing.items[i] && existing.items[i].price) ? existing.items[i].price : (plan.querySelector('.plan-price') ? plan.querySelector('.plan-price').textContent.trim() : '');
                    const period = (existing && existing.items && existing.items[i] && existing.items[i].period) ? existing.items[i].period : (plan.querySelector('.plan-period') ? plan.querySelector('.plan-period').textContent.trim() : '');
                    const featuresList = (existing && existing.items && existing.items[i] && existing.items[i].features) ? existing.items[i].features.join('\n') : Array.from(plan.querySelectorAll('.plan-features li')).map(li=>li.textContent.trim()).join('\n');
                    html += `<div class="mb-3"><label class="form-label">Plan ${i+1} - T√≠tulo</label><input class="form-control struct-title" data-index="${i}" value="${escapeHtmlAttr(title)}"></div>`;
                    html += `<div class="mb-3"><label class="form-label">Plan ${i+1} - Precio</label><input class="form-control struct-price" data-index="${i}" value="${escapeHtmlAttr(price)}"></div>`;
                    html += `<div class="mb-3"><label class="form-label">Plan ${i+1} - Per√≠odo</label><input class="form-control struct-period" data-index="${i}" value="${escapeHtmlAttr(period)}"></div>`;
                    html += `<div class="mb-3"><label class="form-label">Plan ${i+1} - Caracter√≠sticas (una por l√≠nea)</label><textarea class="form-control struct-features" data-index="${i}">${escapeHtmlAttr(featuresList)}</textarea></div>`;
                });
                html += '</div>';
            } else if (sectionId === 'contact_form_struct'){
                // contact form: labels/placeholders and form action
                const form = document.querySelector('#contacto form');
                const action = (existing && existing.action) ? existing.action : (form ? form.getAttribute('action') || '' : '');
                const fields = ['name','email','phone','template','message'];
                html += `<div class="mb-3"><label class="form-label">Form Action</label><input class="form-control struct-action" value="${escapeHtmlAttr(action)}"></div>`;
                fields.forEach((f)=>{
                    const el = form ? form.querySelector(`[name="${f}"]`) : null;
                    const label = el ? (el.closest('.mb-3') ? (el.closest('.mb-3').querySelector('label') ? el.closest('.mb-3').querySelector('label').textContent.trim() : '') : '') : '';
                    const placeholder = el ? (el.getAttribute('placeholder')||'') : '';
                    const valLabel = (existing && existing.fields && existing.fields[f] && existing.fields[f].label) ? existing.fields[f].label : label;
                    const valPlaceholder = (existing && existing.fields && existing.fields[f] && existing.fields[f].placeholder) ? existing.fields[f].placeholder : placeholder;
                    html += `<div class="mb-3"><label class="form-label">Campo ${f} - Label</label><input class="form-control struct-field-label" data-field="${f}" value="${escapeHtmlAttr(valLabel)}"></div>`;
                    html += `<div class="mb-3"><label class="form-label">Campo ${f} - Placeholder</label><input class="form-control struct-field-placeholder" data-field="${f}" value="${escapeHtmlAttr(valPlaceholder)}"></div>`;
                });
            }

            // inject into modal content area
            contentArea.innerHTML = html;
            // show content mode and hide attr area
            contentArea.classList.remove('d-none'); attrArea.classList.add('d-none'); document.getElementById('modeContent').checked = true; document.getElementById('modeAttr').checked = false;

            const modal = new bootstrap.Modal(modalEl, { backdrop: true }); modal.show();
        }

        function saveStructuredEditor(){
            const sectionId = document.getElementById('sectionEditId').value;
            const modalEl = document.getElementById('sectionEditModal');
            try {
                if (!modalEl || modalEl.dataset.publicSection !== '1') return alert('Modo estructurado solo para edici√≥n p√∫blica');
                const sel = modalEl.dataset.targetSelector;
                if (sectionId === 'features_struct'){
                    const items = [];
                    document.querySelectorAll('.struct-title').forEach((inp)=>{
                        const i = Number(inp.dataset.index);
                        items[i] = items[i] || {}; items[i].title = inp.value;
                    });
                    document.querySelectorAll('.struct-bullets').forEach((ta)=>{
                        const i = Number(ta.dataset.index);
                        items[i] = items[i] || {}; items[i].bullets = ta.value.split('\n').map(s=>s.trim()).filter(Boolean);
                    });
                    const payload = { __structured: true, type: 'features', items };
                    localStorage.setItem('public_section_' + sectionId, JSON.stringify(payload));
                    // apply immediately in admin preview
                    try {
                        const cards = document.querySelectorAll(sel + ' .feature-card');
                        items.forEach((it, idx)=>{
                            const card = cards[idx]; if (!card) return;
                            const h = card.querySelector('h3'); if (h) h.textContent = it.title || '';
                            const ul = card.querySelector('.feature-list'); if (ul){ ul.innerHTML = ''; it.bullets.forEach(b => { const li = document.createElement('li'); li.textContent = b; ul.appendChild(li); }); }
                        });
                    } catch(e){}
                } else if (sectionId === 'plans_struct'){
                    const items = [];
                    document.querySelectorAll('.struct-title').forEach((inp)=>{ const i=Number(inp.dataset.index); items[i]=items[i]||{}; items[i].title = inp.value; });
                    document.querySelectorAll('.struct-price').forEach((inp)=>{ const i=Number(inp.dataset.index); items[i]=items[i]||{}; items[i].price = inp.value; });
                    document.querySelectorAll('.struct-period').forEach((inp)=>{ const i=Number(inp.dataset.index); items[i]=items[i]||{}; items[i].period = inp.value; });
                    document.querySelectorAll('.struct-features').forEach((ta)=>{ const i=Number(ta.dataset.index); items[i]=items[i]||{}; items[i].features = ta.value.split('\n').map(s=>s.trim()).filter(Boolean); });
                    const payload = { __structured:true, type:'plans', items };
                    localStorage.setItem('public_section_' + sectionId, JSON.stringify(payload));
                    try {
                        const plans = document.querySelectorAll(sel + ' .plan-card');
                        items.forEach((it, idx)=>{
                            const p = plans[idx]; if (!p) return; const h = p.querySelector('h3'); if (h) h.textContent = it.title||''; const pr = p.querySelector('.plan-price'); if (pr) pr.textContent = it.price||''; const pd = p.querySelector('.plan-period'); if (pd) pd.textContent = it.period||''; const ul = p.querySelector('.plan-features'); if (ul){ ul.innerHTML=''; it.features.forEach(f=>{ const li=document.createElement('li'); li.textContent = f; ul.appendChild(li); }); }
                        });
                    } catch(e){}
                } else if (sectionId === 'contact_form_struct'){
                    const action = document.querySelector('.struct-action') ? document.querySelector('.struct-action').value : '';
                    const fields = {};
                    document.querySelectorAll('.struct-field-label').forEach(inp => { const f = inp.dataset.field; fields[f] = fields[f] || {}; fields[f].label = inp.value; });
                    document.querySelectorAll('.struct-field-placeholder').forEach(inp => { const f = inp.dataset.field; fields[f] = fields[f] || {}; fields[f].placeholder = inp.value; });
                    const payload = { __structured:true, type:'contact_form', action, fields };
                    localStorage.setItem('public_section_' + sectionId, JSON.stringify(payload));
                    try {
                        const form = document.querySelector(sel);
                        if (form && action) form.setAttribute('action', action);
                        Object.keys(fields).forEach(fname => {
                            const el = form ? form.querySelector('[name="'+fname+'"]') : null;
                            if (!el) return;
                            const wrapper = el.closest('.mb-3'); if (wrapper && wrapper.querySelector('label')) wrapper.querySelector('label').textContent = fields[fname].label || wrapper.querySelector('label').textContent;
                            if (fields[fname].placeholder !== undefined) el.setAttribute('placeholder', fields[fname].placeholder);
                        });
                    } catch(e){}
                }
                // dispatch storage
                try { window.dispatchEvent(new Event('storage')); } catch(e){}
                const modal = bootstrap.Modal.getInstance(modalEl); if (modal) modal.hide();
            } catch(e){ console.error(e); alert('Error guardando estructurado'); }
        }

        // helper to escape attribute values into HTML
        function escapeHtmlAttr(s){ if (s===null || s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // attach saveStructured when Save clicked if modal in structured mode
        document.addEventListener('DOMContentLoaded', function(){ const saveBtn = document.getElementById('sectionEditSave'); if (saveBtn) { saveBtn.addEventListener('click', function(){ const sectionId = document.getElementById('sectionEditId').value; if (sectionId && (sectionId.endsWith('_struct') || sectionId === 'contact_form_struct')) { saveStructuredEditor(); } else { saveSectionEditor(); } }); } });
    });

    </script>

</body>
</html>